{
  "name": "Workflow nutrribuddy completo",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "20cf51d3-4254-4cd3-9ad2-3395debddf46",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "e9c85516-748c-4d36-9fb1-2ffd616bcfe8",
      "name": "Webhook: Nova Mensagem",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        9568,
        -1744
      ],
      "webhookId": "20cf51d3-4254-4cd3-9ad2-3395debddf46"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 1. VALIDAR E PROCESSAR (V4 - COM PRIORIDADE DE FOTO)\n// =====================================================\n\nconst inputData = $input.first().json;\n\n// ðŸ” Tentar encontrar os dados na raiz ou dentro de 'body'\nconst data = inputData.body || inputData;\n\nconsole.log('=== DEBUG PAYLOAD ===');\nconsole.log('Keys na raiz:', Object.keys(inputData));\nconsole.log('Keys em data:', Object.keys(data));\nconsole.log('ConversationId:', data.conversationId);\n\n// Apenas processar mensagens de PACIENTES\nif (data.senderRole !== 'patient') {\n  return {\n    json: {\n      skipped: true,\n      reason: 'Mensagem do prescritor - nÃ£o precisa processar',\n      conversationId: data.conversationId\n    }\n  };\n}\n\n// Normalizar attachments\nlet attachments = data.attachments || [];\nif (attachments.length === 0 && data.mediaUrl) {\n  attachments.push({\n    url: data.mediaUrl,\n    type: data.type || 'file'\n  });\n}\n\n// =====================================================\n// ðŸ”¥ DETECÃ‡ÃƒO DE FOTO - PRIORIDADE ABSOLUTA\n// =====================================================\nconst hasImage = \n  data.hasImage === true ||\n  data.type === 'image' ||\n  (attachments && attachments.some(a => \n    a.type === 'image' || \n    a.contentType?.startsWith('image/')\n  )) ||\n  !!data.imageUrl;\n\nconst hasAudio = \n  data.hasAudio === true ||\n  data.type === 'audio' ||\n  !!data.audioUrl;\n\n// Flag de prioridade: tem foto com URL vÃ¡lida\nconst photoPriority = hasImage && !!(data.mediaUrl || data.imageUrl || attachments[0]?.url);\n\nif (photoPriority) {\n  console.log('ðŸ”¥ [VALIDAR] FOTO DETECTADA - PRIORIDADE MÃXIMA');\n  console.log('ðŸ“¸ [VALIDAR] URL:', (data.mediaUrl || data.imageUrl || attachments[0]?.url)?.substring(0, 60) + '...');\n}\n\n// =====================================================\n// RETORNO SANITIZADO COM FLAGS DE PRIORIDADE\n// =====================================================\nreturn {\n  json: {\n    // Dados bÃ¡sicos\n    conversationId: String(data.conversationId || '').trim(),\n    messageId: String(data.messageId || '').trim(),\n    senderId: String(data.senderId || '').trim(),\n    senderRole: data.senderRole,\n    content: String(data.content || '').trim(),\n    type: data.type || 'text',\n    \n    // MÃ­dia\n    mediaUrl: data.mediaUrl || data.imageUrl || null,\n    imageUrl: data.imageUrl || (hasImage ? data.mediaUrl : null),\n    audioUrl: data.audioUrl || (hasAudio ? data.mediaUrl : null),\n    hasImage: hasImage,\n    hasAudio: hasAudio,\n    attachments: attachments,\n    \n    // IDs\n    patientId: data.patientId || data.senderId,\n    prescriberId: data.prescriberId,\n    \n    // Metadados\n    timestamp: data.timestamp || new Date().toISOString(),\n    patientPhone: data.patientPhone,\n    patientName: data.patientName || data.senderName,\n    channel: data.channel || 'whatsapp',\n    source: data.source || 'whatsapp-baileys',\n    \n    // ðŸ”¥ FLAGS DE PRIORIDADE - CRUCIAL!\n    _photoPriority: photoPriority,\n    _skipGenericResponse: photoPriority,  // NÃ£o enviar \"Oi, hora do almoÃ§o!\"\n    _waitForAnalysis: photoPriority,       // Esperar anÃ¡lise completar\n    _mediaType: hasImage ? 'image' : (hasAudio ? 'audio' : 'text'),\n    \n    // Debug\n    _raw: inputData\n  }\n};\n"
      },
      "id": "27c3e736-1d67-499b-8e91-6f707d361d83",
      "name": "1. Validar e Processar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9792,
        -1744
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "caa174a2-ef1b-45ff-a257-17d5250f2234",
              "leftValue": "={{ $json.filtered === true || $json.filtered === 'true' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "8d648314-2dab-4c09-b7f5-e1bcb3677e5f",
      "name": "2. Foi Filtrado?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        10016,
        -1744
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, filtered: true, reason: $json.reason } }}",
        "options": {}
      },
      "id": "039749a5-c243-468e-8b09-cacb0789d63d",
      "name": "Responder: Filtrado",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        10240,
        -1840
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "8c5e3d7b-9a1c-4b2e-9d8f-7e6a5b4c3d2e",
              "leftValue": "={{ $json.data.patientStatus }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ec6b67a5-22da-4d7b-978f-dc7b6660257b",
      "name": "3-bis. Checar Assinatura",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        14512,
        -1328
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "a1b2c3d4-e5f6-4a5b-bcde-f1e2d3c4b5a6",
              "leftValue": "={{ $json.data.patientStatus }}",
              "rightValue": "active",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "cd42167d-7773-456c-a97b-56b8db6fbb3e",
      "name": "4-bis. Checar (FOTO)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        10592,
        -1760
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: false, error: 'suspended', message: 'âš ï¸ Seu acesso ao NutriBuddy estÃ¡ pendente de regularizaÃ§Ã£o.\\\n\\\nPara continuar registrando suas refeiÃ§Ãµes e recebendo acompanhamento nutricional inteligente, regularize seu plano agora em: https://nutribuddy.app/regularizar?p=' + ($json.data.patientId || $json.patientId) } }}",
        "options": {}
      },
      "id": "031cbeab-5429-4619-b4e3-ffd4069caaf1",
      "name": "Responder: Assinatura Suspensa",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        10800,
        -1888
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar' ).item.json.conversationId }}\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "693f08b9-62ad-4f99-b767-e3e3748d0d5e",
      "name": "3. Buscar Conversa",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        14400,
        -1328
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar').item.json.conversationId }}/messages?limit=100",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "812a5bb3-a834-4593-9a6c-80311bfb8453",
      "name": "4. Buscar HistÃ³rico",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        14624,
        -1280
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $('1. Validar e Processar').item.json.patientId }}/diet",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "04493ffb-5eca-4d46-8c97-e1263fb2a2f7",
      "name": "5. Buscar Dieta do Paciente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        14848,
        -1280
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// 6. CONSTRUIR CONTEXTO IA (VERSÃƒO FINAL CORRIGIDA)\n// ============================================\n// Este nÃ³ monta o contexto completo para a IA (GPT-4o)\n// incluindo dados do paciente, dieta, histÃ³rico e instruÃ§Ãµes de raciocÃ­nio\n\n// 1. RECUPERAR CONTEÃšDO DA MENSAGEM (PRIORIZANDO TRANSCRIÃ‡ÃƒO)\nlet userContent = '';\nlet isTranscribed = false;\n\ntry {\n  const audioItem = $('AUDIO: 4. Parse TranscriÃ§Ã£o').first();\n  if (audioItem && audioItem.json && audioItem.json.content) {\n    userContent = audioItem.json.content;\n    isTranscribed = true;\n    console.log('ðŸŽ™ï¸ TranscriÃ§Ã£o recuperada:', userContent);\n  }\n} catch (e) {\n  // Ignora erro se o nÃ³ nÃ£o foi executado (mensagem de texto normal)\n}\n\nif (!userContent) {\n  try {\n    userContent = $('1. Validar e Processar').first().json.content;\n    console.log('ðŸ“ ConteÃºdo original (texto):', userContent);\n  } catch (e) {\n    userContent = '';\n    console.log('âš ï¸ ConteÃºdo vazio');\n  }\n}\n\n// Objeto consolidado da mensagem atual\nconst currentItem = {\n  ...$('1. Validar e Processar').first().json,\n  content: userContent,\n  isTranscribed: isTranscribed\n};\n\n// Extrair dados bÃ¡sicos\nconst patientId = $('1. Validar e Processar').first().json.patientId || $('1. Validar e Processar').first().json.body?.patientId;\nconst prescriberId = $('1. Validar e Processar').first().json.prescriberId || $('1. Validar e Processar').first().json.body?.prescriberId;\nconst conversationId = $('1. Validar e Processar').first().json.conversationId || $('1. Validar e Processar').first().json.body?.conversationId;\nconst messageContent = userContent || $('1. Validar e Processar').first().json.content || '';\nconst senderRole = $('1. Validar e Processar').first().json.senderRole || $('1. Validar e Processar').first().json.body?.senderRole || 'patient';\n\n// ============================================\n// CONTEXTO TEMPORAL (HORÃRIO ATUAL)\n// ============================================\nconst agora = new Date();\nconst horaAtual = agora.getHours();\nconst minutosAtual = agora.getMinutes();\nconst horaFormatada = `${String(horaAtual).padStart(2, '0')}:${String(minutosAtual).padStart(2, '0')}`;\n\n// Determinar refeiÃ§Ã£o esperada baseada no horÃ¡rio\nlet refeicaoEsperada = 'lanche';\nlet refeicoesPossiveis = [];\nlet refeicoesPassadas = [];\n\nif (horaAtual >= 5 && horaAtual < 10) {\n  // ManhÃ£ (5h - 9h59): CafÃ© da manhÃ£\n  refeicaoEsperada = 'cafÃ© da manhÃ£';\n  refeicoesPossiveis = ['cafÃ© da manhÃ£'];\n  refeicoesPassadas = [];\n} else if (horaAtual >= 10 && horaAtual < 12) {\n  // Meio da manhÃ£ (10h - 11h59): Lanche ou cafÃ© da manhÃ£ tardio\n  refeicaoEsperada = 'lanche da manhÃ£';\n  refeicoesPossiveis = ['lanche da manhÃ£', 'cafÃ© da manhÃ£'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£'];\n} else if (horaAtual >= 12 && horaAtual < 15) {\n  // AlmoÃ§o (12h - 14h59)\n  refeicaoEsperada = 'almoÃ§o';\n  refeicoesPossiveis = ['almoÃ§o'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£'];\n} else if (horaAtual >= 15 && horaAtual < 18) {\n  // Tarde (15h - 17h59): Lanche da tarde\n  refeicaoEsperada = 'lanche da tarde';\n  refeicoesPossiveis = ['lanche da tarde'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£', 'almoÃ§o'];\n} else if (horaAtual >= 18 && horaAtual < 22) {\n  // Noite (18h - 21h59): Jantar\n  refeicaoEsperada = 'jantar';\n  refeicoesPossiveis = ['jantar'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£', 'almoÃ§o', 'lanche da tarde'];\n} else {\n  // Madrugada (22h - 4h59): Ceia ou nada\n  refeicaoEsperada = 'ceia';\n  refeicoesPossiveis = ['ceia'];\n  refeicoesPassadas = ['cafÃ© da manhÃ£', 'lanche da manhÃ£', 'almoÃ§o', 'lanche da tarde', 'jantar'];\n}\n\nconst contextoTemporal = `\n=== CONTEXTO TEMPORAL ===\nHorÃ¡rio Atual: ${horaFormatada} (${horaAtual}h${minutosAtual > 0 ? minutosAtual : ''})\nRefeiÃ§Ã£o Esperada Neste HorÃ¡rio: ${refeicaoEsperada}\nRefeiÃ§Ãµes PossÃ­veis Agora: ${refeicoesPossiveis.join(', ')}\nRefeiÃ§Ãµes que JÃ¡ Passaram Hoje: ${refeicoesPassadas.length > 0 ? refeicoesPassadas.join(', ') : 'Nenhuma ainda'}\n\nâš ï¸ REGRAS TEMPORAIS IMPORTANTES:\n1. NUNCA pergunte sobre refeiÃ§Ãµes que ainda nÃ£o aconteceram no horÃ¡rio atual\n   - Se sÃ£o ${horaFormatada} da manhÃ£ â†’ NÃƒO pergunte sobre almoÃ§o ou jantar\n   - Se sÃ£o ${horaFormatada} da tarde â†’ NÃƒO pergunte sobre jantar (ainda nÃ£o chegou)\n   - Se sÃ£o ${horaFormatada} da noite â†’ Pode perguntar sobre qualquer refeiÃ§Ã£o do dia\n\n2. Quando o paciente perguntar sobre uma refeiÃ§Ã£o:\n   - Se a refeiÃ§Ã£o JÃ PASSOU â†’ Busque no histÃ³rico e responda\n   - Se a refeiÃ§Ã£o AINDA NÃƒO ACONTECEU â†’ Diga: \"Ainda nÃ£o Ã© horÃ¡rio de ${refeicaoEsperada}. O horÃ¡rio atual Ã© ${horaFormatada}.\"\n\n3. Exemplos de respostas corretas (RESUMIDAS):\n   - Paciente Ã s 9h: \"O que comi no almoÃ§o?\" â†’ \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o ${horaFormatada}. Quer saber sobre o cafÃ© da manhÃ£? â˜•\"\n   - Paciente Ã s 14h: \"O que comi no almoÃ§o?\" â†’ \"No almoÃ§o vocÃª comeu: [lista alimentos]. Total: X kcal, P: Xg C: Xg G: Xg.\"\n   - Paciente Ã s 9h: \"O que comi no cafÃ©?\" â†’ \"No cafÃ© vocÃª comeu: [lista alimentos]. Total: X kcal.\"\n   - IMPORTANTE: Seja DIRETO. NÃ£o explique demais. VÃ¡ direto ao ponto.\n\n4. Seja INTELIGENTE sobre contexto temporal:\n   - Considere o horÃ¡rio ao responder perguntas sobre refeiÃ§Ãµes\n   - NÃ£o assuma que refeiÃ§Ãµes futuras jÃ¡ aconteceram\n   - Use bom senso sobre o que faz sentido perguntar naquele horÃ¡rio\n`;\n\n// Buscar dados do paciente do Firebase (via nÃ³ 5z)\nlet patientData = null;\nlet dietPlanData = null;\n\ntry {\n  const patientContextNode = $('5z. Buscar Contexto Completo do Paciente');\n  if (patientContextNode && patientContextNode.first()) {\n    const contextData = patientContextNode.first().json.context || {};\n    patientData = contextData.patient || null;\n    dietPlanData = contextData.dietPlan || null;\n    console.log('âœ… Dados do paciente recuperados do nÃ³ 5z');\n  }\n} catch (e) {\n  console.log('âš ï¸ NÃ£o foi possÃ­vel buscar dados do paciente do nÃ³ 5z:', e.message);\n}\n\n// Se nÃ£o encontrou, tentar buscar do nÃ³ de dieta\nif (!dietPlanData) {\n  try {\n    const dietNode = $('5. Buscar Dieta do Paciente');\n    if (dietNode && dietNode.first()) {\n      dietPlanData = dietNode.first().json.data || null;\n    }\n  } catch (e) {\n    console.log('âš ï¸ NÃ£o foi possÃ­vel buscar dieta');\n  }\n}\n\n// Buscar histÃ³rico formatado (se disponÃ­vel)\nlet historicoFormatado = '';\nlet temHistorico = false;\nlet summaryMacros = null;\nlet logsPorData = {};\n\ntry {\n  const historicoNode = $('4. Buscar HistÃ³rico');\n  if (historicoNode && historicoNode.first()) {\n    const historicoData = historicoNode.first().json;\n    const messages = historicoData.messages || [];\n    \n    if (messages.length > 0) {\n      temHistorico = true;\n      \n      // Agrupar por data\n      const hoje = new Date().toISOString().split('T')[0];\n      const logsHoje = [];\n      \n      messages.forEach(msg => {\n        const msgDate = msg.date || msg.createdAt?.split('T')[0] || hoje;\n        if (!logsPorData[msgDate]) {\n          logsPorData[msgDate] = [];\n        }\n        logsPorData[msgDate].push(msg);\n        \n        if (msgDate === hoje) {\n          logsHoje.push(msg);\n        }\n      });\n      \n      // Formatar histÃ³rico do dia atual\n      if (logsHoje.length > 0) {\n        historicoFormatado = logsHoje.map(log => {\n          const tipo = log.type || 'refeiÃ§Ã£o';\n          const alimentos = log.foods || log.alimentos || [];\n          const macros = log.macros || {};\n          \n          return `${tipo}: ${alimentos.map(a => a.nome || a.name || 'Alimento').join(', ')} - P:${macros.protein || macros.proteinas || 0}g C:${macros.carbs || macros.carboidratos || 0}g G:${macros.fats || macros.gorduras || 0}g Cal:${macros.calories || macros.calorias || 0}kcal`;\n        }).join('\\n');\n        \n        // Calcular totais do dia\n        summaryMacros = logsHoje.reduce((acc, log) => {\n          const macros = log.macros || {};\n          return {\n            protein: (acc.protein || 0) + (macros.protein || macros.proteinas || 0),\n            carbs: (acc.carbs || 0) + (macros.carbs || macros.carboidratos || 0),\n            fats: (acc.fats || 0) + (macros.fats || macros.gorduras || 0),\n            calories: (acc.calories || 0) + (macros.calories || macros.calorias || 0),\n            date: hoje\n          };\n        }, { protein: 0, carbs: 0, fats: 0, calories: 0 });\n      }\n    }\n  }\n} catch (e) {\n  console.log('âš ï¸ HistÃ³rico nÃ£o disponÃ­vel:', e.message);\n}\n\n// Buscar histÃ³rico de conversas (Ãºltimas mensagens)\nlet conversationHistory = [];\ntry {\n  const historyNode = $('4. Buscar HistÃ³rico');\n  if (historyNode && historyNode.first()) {\n    const historyData = historyNode.first().json;\n    if (Array.isArray(historyData.messages)) {\n      conversationHistory = historyData.messages.slice(-10); // Ãšltimas 10 mensagens\n    }\n  }\n} catch (e) {\n  console.log('âš ï¸ HistÃ³rico de conversa nÃ£o disponÃ­vel');\n}\n\n// Formatar histÃ³rico de conversa para o prompt\nconst conversationHistoryText = conversationHistory.length > 0\n  ? conversationHistory.map(msg => {\n      const role = msg.senderRole === 'patient' ? 'Paciente' : 'NutriBuddy';\n      const content = msg.content || '';\n      return `${role}: ${content}`;\n    }).join('\\n')\n  : 'Nenhuma conversa anterior registrada.';\n\n// Buscar dados da conversa (com tratamento de erro caso o nÃ³ nÃ£o tenha sido executado)\n// âœ… CORREÃ‡ÃƒO: A variÃ¡vel 'conversation' nÃ£o Ã© usada no cÃ³digo, entÃ£o podemos simplesmente nÃ£o acessÃ¡-la\n// Se precisar dos dados da conversa no futuro, adicione aqui com tratamento de erro adequado\nlet conversation = null;\n\n// NOTA: O nÃ³ \"3. Buscar Conversa\" pode nÃ£o ser executado em fluxos de histÃ³rico.\n// Como a variÃ¡vel 'conversation' nÃ£o Ã© usada neste cÃ³digo, nÃ£o precisamos acessÃ¡-la.\n// Se no futuro precisar dos dados da conversa, descomente o cÃ³digo abaixo:\n/*\ntry {\n  conversation = $('3. Buscar Conversa').first().json;\n  console.log('âœ… Dados da conversa recuperados');\n} catch (e) {\n  console.log('âš ï¸ NÃ³ \"3. Buscar Conversa\" nÃ£o foi executado (normal para perguntas sobre histÃ³rico):', e.message);\n  conversation = null;\n}\n*/\n\n// Montar informaÃ§Ãµes do paciente\nconst patientInfo = patientData ? `\n=== DADOS DO PACIENTE ===\nNome: ${patientData.name || 'NÃ£o informado'}\nIdade: ${patientData.age || 'NÃ£o informado'} anos\nPeso Atual: ${patientData.weight || patientData.currentWeight || 'NÃ£o informado'} kg\nAltura: ${patientData.height || 'NÃ£o informado'} cm\nGÃªnero: ${patientData.gender === 'male' ? 'Masculino' : patientData.gender === 'female' ? 'Feminino' : patientData.gender || 'NÃ£o informado'}\n\n=== METAS E OBJETIVOS ===\nObjetivo Principal: ${patientData.objective === 'lose_weight' ? 'Perder Peso' : \n                     patientData.objective === 'gain_muscle' ? 'Ganhar Massa Muscular' : \n                     patientData.objective === 'gain_weight' ? 'Ganhar Peso' : \n                     patientData.objective === 'maintain' ? 'Manter Peso' : \n                     patientData.objective === 'performance' ? 'Performance' : \n                     patientData.objective === 'health' ? 'SaÃºde Geral' : \n                     patientData.objective || 'NÃ£o informado'}\nPeso Inicial: ${patientData.initialWeight || 'NÃ£o informado'} kg\nPeso Alvo: ${patientData.targetWeight || 'NÃ£o informado'} kg\nMetas Semanais: ${Array.isArray(patientData.weeklyGoals) ? patientData.weeklyGoals.join(', ') : 'Nenhuma'}\n\n=== PERFIL DE SAÃšDE ===\nAlergias: ${Array.isArray(patientData.allergies) && patientData.allergies.length > 0 ? patientData.allergies.join(', ') : 'Nenhuma'}\nOutras Alergias: ${patientData.otherAllergies || 'Nenhuma'}\nCondiÃ§Ãµes de SaÃºde: ${Array.isArray(patientData.healthConditions) && patientData.healthConditions.length > 0 ? patientData.healthConditions.join(', ') : 'Nenhuma'}\nMedicamentos: ${patientData.medications || 'Nenhum'}\n\n=== PREFERÃŠNCIAS ALIMENTARES ===\nEstilo Alimentar: ${patientData.foodStyle === 'vegetarian' ? 'Vegetariano' : \n                   patientData.foodStyle === 'vegan' ? 'Vegano' : \n                   patientData.foodStyle === 'omnivore' ? 'OnÃ­voro' : \n                   patientData.foodStyle || 'NÃ£o informado'}\nAlimentos Favoritos: ${Array.isArray(patientData.favoriteFoods) && patientData.favoriteFoods.length > 0 ? patientData.favoriteFoods.join(', ') : 'Nenhum'}\nAlimentos que NÃ£o Gosta: ${Array.isArray(patientData.dislikedFoods) && patientData.dislikedFoods.length > 0 ? patientData.dislikedFoods.join(', ') : 'Nenhum'}\nRestriÃ§Ãµes Alimentares: ${Array.isArray(patientData.dietaryRestrictions) && patientData.dietaryRestrictions.length > 0 ? patientData.dietaryRestrictions.join(', ') : 'Nenhuma'}\n\n=== ESTILO DE VIDA ===\nNÃ­vel de Atividade: ${patientData.activityLevel === 'sedentary' ? 'SedentÃ¡rio' : \n                     patientData.activityLevel === 'light' ? 'Leve' : \n                     patientData.activityLevel === 'moderate' ? 'Moderado' : \n                     patientData.activityLevel === 'active' ? 'Ativo' : \n                     patientData.activityLevel === 'very_active' ? 'Muito Ativo' : \n                     patientData.activityLevel || 'NÃ£o informado'}\nQualidade do Sono: ${patientData.sleepQuality || 'NÃ£o informado'}\nNÃ­vel de Estresse: ${patientData.stressLevel || 'NÃ£o informado'}\nIngestÃ£o de Ãgua: ${patientData.waterIntake || 'NÃ£o informado'}\n` : 'Dados do paciente nÃ£o disponÃ­veis.';\n\n// Montar informaÃ§Ãµes da dieta prescrita\nconst dietInfo = dietPlanData ? `\n=== DIETA PRESCRITA ===\nNome: ${dietPlanData.name || 'Plano Alimentar'}\nDescriÃ§Ã£o: ${dietPlanData.description || 'Sem descriÃ§Ã£o'}\n\nMacros DiÃ¡rios Prescritos:\n- ProteÃ­nas: ${dietPlanData.macros?.protein || dietPlanData.dailyProtein || 0} g\n- Carboidratos: ${dietPlanData.macros?.carbs || dietPlanData.dailyCarbs || 0} g\n- Gorduras: ${dietPlanData.macros?.fats || dietPlanData.dailyFats || 0} g\n- Calorias: ${dietPlanData.macros?.calories || dietPlanData.dailyCalories || dietPlanData.calories || 0} kcal\n\nRefeiÃ§Ãµes Planejadas: ${Array.isArray(dietPlanData.meals) && dietPlanData.meals.length > 0 \n  ? dietPlanData.meals.map(m => `\\n  - ${m.title || m.name || 'RefeiÃ§Ã£o'} (${m.time || ''})`).join('')\n  : 'Nenhuma refeiÃ§Ã£o planejada'}\n` : `\n=== DIETA PRESCRITA ===\nNenhuma dieta prescrita encontrada. Use os dados do perfil do paciente para orientaÃ§Ãµes gerais.\n`;\n\n// Montar contexto de histÃ³rico alimentar (se disponÃ­vel)\nlet historicoContext = '';\nif (temHistorico && historicoFormatado) {\n  const macrosPrescritos = dietPlanData ? {\n    protein: dietPlanData.macros?.protein || dietPlanData.dailyProtein || 0,\n    carbs: dietPlanData.macros?.carbs || dietPlanData.dailyCarbs || 0,\n    fats: dietPlanData.macros?.fats || dietPlanData.dailyFats || 0,\n    calories: dietPlanData.macros?.calories || dietPlanData.dailyCalories || dietPlanData.calories || 0\n  } : null;\n\n  historicoContext = `\n\n=== HISTÃ“RICO ALIMENTAR DO PACIENTE ===\n\n${historicoFormatado}\n\n${summaryMacros ? `\n=== RESUMO DE MACROS CONSUMIDOS ===\n${summaryMacros.date ? `Data: ${summaryMacros.date}` : ''}\n- ProteÃ­nas: ${summaryMacros.protein || 0} g\n- Carboidratos: ${summaryMacros.carbs || 0} g\n- Gorduras: ${summaryMacros.fats || 0} g\n- Calorias: ${summaryMacros.calories || 0} kcal\n` : ''}\n\n${macrosPrescritos ? `\n=== COMPARAÃ‡ÃƒO COM DIETA PRESCRITA ===\nProteÃ­nas: ${summaryMacros?.protein || 0} g consumidas de ${macrosPrescritos.protein} g prescritas (${macrosPrescritos.protein > 0 ? Math.round(((summaryMacros?.protein || 0) / macrosPrescritos.protein) * 100) : 0}%)\nCarboidratos: ${summaryMacros?.carbs || 0} g consumidos de ${macrosPrescritos.carbs} g prescritos (${macrosPrescritos.carbs > 0 ? Math.round(((summaryMacros?.carbs || 0) / macrosPrescritos.carbs) * 100) : 0}%)\nGorduras: ${summaryMacros?.fats || 0} g consumidas de ${macrosPrescritos.fats} g prescritas (${macrosPrescritos.fats > 0 ? Math.round(((summaryMacros?.fats || 0) / macrosPrescritos.fats) * 100) : 0}%)\nCalorias: ${summaryMacros?.calories || 0} kcal consumidas de ${macrosPrescritos.calories} kcal prescritas (${macrosPrescritos.calories > 0 ? Math.round(((summaryMacros?.calories || 0) / macrosPrescritos.calories) * 100) : 0}%)\n` : ''}\n\n=== INSTRUÃ‡Ã•ES PARA RACIOCÃNIO DA IA ===\n\nQuando o paciente perguntar sobre seu histÃ³rico alimentar, vocÃª DEVE:\n\n1. **CALCULAR TOTAIS PRECISOS**: Some exatamente os valores de macros do histÃ³rico fornecido. Use os nÃºmeros EXATOS, nÃ£o invente valores.\n\n2. **COMPARAR COM DIETA PRESCRITA**: Compare os macros consumidos com os macros prescritos. Identifique:\n   - O que estÃ¡ faltando (ex: \"Faltam 30g de proteÃ­na para atingir a meta\")\n   - O que estÃ¡ em excesso (ex: \"VocÃª consumiu 200 kcal a mais que o prescrito\")\n   - O que estÃ¡ adequado\n\n3. **IDENTIFICAR PADRÃ•ES**: Analise o histÃ³rico para identificar:\n   - Alimentos mais frequentes\n   - HorÃ¡rios de refeiÃ§Ãµes\n   - DistribuiÃ§Ã£o de macros ao longo do dia\n   - TendÃªncias (ex: sempre come muito carboidrato no almoÃ§o)\n\n4. **RESPONDER PERGUNTAS ESPECÃFICAS COM CONTEXTO TEMPORAL**: Quando o paciente perguntar:\n   - \"O que comi no almoÃ§o?\" â†’ \n     * Se sÃ£o ${horaFormatada} e o almoÃ§o JÃ PASSOU â†’ Liste EXATAMENTE os alimentos do histÃ³rico do almoÃ§o de hoje\n     * Se sÃ£o ${horaFormatada} e o almoÃ§o AINDA NÃƒO ACONTECEU â†’ Diga: \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o ${horaFormatada}. VocÃª quer saber sobre ${refeicaoEsperada}?\"\n   - \"Quanto falta de proteÃ­na?\" â†’ Calcule: prescrito - consumido = falta (considere apenas refeiÃ§Ãµes que jÃ¡ aconteceram)\n   - \"Quanto comi hoje?\" â†’ Some todos os macros das refeiÃ§Ãµes que JÃ ACONTECERAM hoje (nÃ£o conte refeiÃ§Ãµes futuras)\n   - \"O que comi na semana passada?\" â†’ Liste os alimentos do perÃ­odo solicitado\n   - IMPORTANTE: Sempre considere o horÃ¡rio atual ao responder sobre refeiÃ§Ãµes especÃ­ficas\n\n5. **FORNECER INSIGHTS CONSTRUTIVOS**: Baseado nos dados reais:\n   - Sugira ajustes especÃ­ficos (ex: \"Adicione uma fonte de proteÃ­na no lanche da tarde\")\n   - Destaque pontos positivos (ex: \"VocÃª estÃ¡ consumindo boas quantidades de vegetais\")\n   - Alerte sobre padrÃµes preocupantes (ex: \"VocÃª estÃ¡ consumindo muito aÃ§Ãºcar nos lanches\")\n\n6. **NUNCA INVENTE DADOS**: Se nÃ£o houver informaÃ§Ã£o no histÃ³rico, diga claramente \"NÃ£o encontrei registros sobre isso no seu histÃ³rico\". NÃ£o invente refeiÃ§Ãµes ou valores.\n\nIMPORTANTE: Use APENAS os dados fornecidos no histÃ³rico acima. NÃ£o invente informaÃ§Ãµes que nÃ£o estejam presentes.\n`;\n}\n\n// Montar contexto completo\nconst context = `\nVocÃª Ã© o NutriBuddy, um assistente nutricional inteligente e empÃ¡tico que ajuda pacientes a seguirem suas dietas e alcanÃ§arem seus objetivos de saÃºde.\n\nâš ï¸ REGRA FUNDAMENTAL: Seja RESUMIDO e DIRETO. MÃ¡ximo 3-4 frases por resposta. VÃ¡ direto ao ponto!\n\n${contextoTemporal}\n\n${patientInfo}\n\n${dietInfo}\n\n${historicoContext}\n\n=== HISTÃ“RICO DE CONVERSA ===\n${conversationHistoryText}\n\n=== MENSAGEM ATUAL DO PACIENTE ===\n\"${messageContent}\"\n\n=== INSTRUÃ‡Ã•ES GERAIS ===\n\n1. **CONTEXTO TEMPORAL Ã‰ CRÃTICO**: \n   - SEMPRE considere o horÃ¡rio atual (${horaFormatada}) ao responder\n   - NUNCA pergunte ou assuma que refeiÃ§Ãµes futuras jÃ¡ aconteceram\n   - Se o paciente perguntar sobre uma refeiÃ§Ã£o que ainda nÃ£o aconteceu, explique educadamente que ainda nÃ£o Ã© aquele horÃ¡rio\n   - Exemplo: Se sÃ£o 9h da manhÃ£ e perguntam sobre almoÃ§o â†’ \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o 9h da manhÃ£. VocÃª quer saber sobre o cafÃ© da manhÃ£?\"\n\n2. **RESPOSTAS RESUMIDAS E DIRETAS**: \n   - Seja CONCISO e OBJETIVO\n   - MÃ¡ximo 3-4 frases por resposta\n   - VÃ¡ direto ao ponto\n   - Evite repetiÃ§Ãµes e explicaÃ§Ãµes longas\n   - Use 1-2 emojis apenas quando necessÃ¡rio\n   - Exemplo BOM: \"Ainda nÃ£o Ã© horÃ¡rio de almoÃ§o! SÃ£o 9h da manhÃ£. Quer saber sobre o cafÃ© da manhÃ£? â˜•\"\n   - Exemplo RUIM: \"Oi, Paulo! ðŸ˜Š Pelo que estou vendo aqui, ainda nÃ£o tenho registro do que vocÃª comeu no almoÃ§o hoje. Mas tudo bem! Isso acontece, e Ã© super normal esquecer de anotar de vez em quando. Se quiser, posso te ajudar a registrar agora mesmo...\"\n\n3. **TOM EMPÃTICO E MOTIVADOR**: Seja acolhedor, positivo e encorajador, mas de forma RESUMIDA.\n\n4. **PERSONALIZAÃ‡ÃƒO**: Use os dados do paciente (nome, objetivos, preferÃªncias) para personalizar suas respostas de forma CONCISA.\n\n5. **PRECISÃƒO NUTRICIONAL**: Quando falar sobre macros ou valores nutricionais, use os dados EXATOS do histÃ³rico e dieta prescrita. Seja DIRETO com os nÃºmeros.\n\n6. **ORIENTAÃ‡Ã•ES PRÃTICAS**: ForneÃ§a sugestÃµes concretas e acionÃ¡veis, mas de forma RESUMIDA (1-2 frases).\n\n7. **RESPEITO Ã€S RESTRIÃ‡Ã•ES**: Sempre considere alergias, restriÃ§Ãµes alimentares e preferÃªncias do paciente.\n\n8. **MOTIVAÃ‡ÃƒO**: ReconheÃ§a esforÃ§os e progressos de forma BREVE (1 frase).\n\n9. **CLAREZA**: Explique conceitos nutricionais de forma simples e DIRETA.\n\nâš ï¸ REGRA DE OURO: Se vocÃª conseguir dizer em 2 frases, NÃƒO use 5. Seja DIRETO e OBJETIVO.\n\nAnalise a mensagem do paciente e responda de forma RESUMIDA e apropriada, considerando TODO o contexto fornecido acima.\n`;\n\n// Montar payload para a IA\nconst aiPayload = {\n  model: 'gpt-4o',\n  messages: [\n    {\n      role: 'system',\n      content: context\n    },\n    {\n      role: 'user',\n      content: messageContent\n    }\n  ],\n  temperature: 0.7,\n  max_tokens: 500, // Reduzido para forÃ§ar respostas mais curtas\n  response_format: {\n    type: 'json_schema',\n    json_schema: {\n      name: 'nutribuddy_response',\n      strict: true,\n      schema: {\n        type: 'object',\n        properties: {\n          categoria: {\n            type: 'string',\n            enum: ['consulta_historico', 'registro_refeicao', 'duvida_nutricional', 'motivacao', 'outro']\n          },\n          resposta: {\n            type: 'string',\n            description: 'Resposta RESUMIDA e DIRETA para o paciente (mÃ¡ximo 3-4 frases, seja conciso)'\n          },\n          acao: {\n            type: 'string',\n            enum: ['nenhuma', 'registrar_refeicao', 'buscar_historico', 'esclarecer_duvida'],\n            description: 'AÃ§Ã£o que deve ser tomada apÃ³s a resposta'\n          },\n          alimentos: {\n            type: 'array',\n            items: {\n              type: 'object',\n              properties: {\n                nome: { type: 'string' },\n                quantidade: { type: 'string' },\n                macros: {\n                  type: 'object',\n                  properties: {\n                    protein: { type: 'number' },\n                    carbs: { type: 'number' },\n                    fats: { type: 'number' },\n                    calories: { type: 'number' }\n                  }\n                }\n              }\n            },\n            description: 'Lista de alimentos mencionados (se houver)'\n          }\n        },\n        required: ['categoria', 'resposta', 'acao']\n      }\n    }\n  }\n};\n\nreturn {\n  json: {\n    patientId,\n    prescriberId,\n    conversationId,\n    messageContent,\n    senderRole,\n    context,\n    aiPayload,\n    hasPatientData: !!patientData,\n    hasDietPlan: !!dietPlanData,\n    hasHistory: temHistorico\n  }\n};\n"
      },
      "id": "c35bcda4-f65b-492d-8874-9551e6effa55",
      "name": "6. Construir Contexto IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16320,
        -1280
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.context }}"
            }
          ]
        },
        "options": {
          "maxTokens": 800,
          "temperature": 0.7
        }
      },
      "id": "30a62eee-3844-462e-909c-459bd345d261",
      "name": "7. AnÃ¡lise IA (OpenAI)",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [
        16544,
        -1280
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse resposta da IA\nconst currentItem = $('6. Construir Contexto IA').first().json;\nconst aiResponse = $input.first().json.message?.content || $input.first().json.text || '{}';\n\nconsole.log('=== RESPOSTA IA ===');\nconsole.log(aiResponse);\n\nlet parsed;\ntry {\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('JSON nÃ£o encontrado');\n  }\n} catch (error) {\n  console.error('Erro ao fazer parse:', error);\n  parsed = {\n    urgencia: 'baixa',\n    sentimento: 'neutro',\n    categoria: 'duvida_alimentacao',\n    deve_responder: true,\n    resposta: aiResponse\n  };\n}\n\nreturn {\n  json: {\n    ...currentItem,\n    urgencia: parsed.urgencia || 'baixa',\n    sentimento: parsed.sentimento || 'neutro',\n    categoria: parsed.categoria || 'duvida_alimentacao',\n    deve_responder: parsed.deve_responder !== false,\n    resposta: parsed.resposta || aiResponse\n  }\n};"
      },
      "id": "6a4bc41b-c653-4c80-acb1-ff47e0345f30",
      "name": "8. Parse AnÃ¡lise IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16896,
        -1280
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "99b4b2d4-2840-4905-8650-d17c0ef2409e",
              "leftValue": "={{ $json.deve_responder }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "7c6997d9-d1db-4739-a438-bfbaca2cd70e",
      "name": "9. Deve Responder?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        17120,
        -1280
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "senderId",
              "value": "={{ $json.prescriberId }}"
            },
            {
              "name": "senderRole",
              "value": "prescriber"
            },
            {
              "name": "content",
              "value": "={{ $json.resposta }}"
            },
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "isAiGenerated",
              "value": "true"
            }
          ]
        },
        "options": {}
      },
      "id": "cb1ef551-6732-4643-94f7-5f28fbe5a60e",
      "name": "10. Enviar Auto-resposta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        17344,
        -1504
      ]
    },
    {
      "parameters": {},
      "id": "e417f222-e5d1-49a9-acd4-77039788ac93",
      "name": "NÃ£o Responder",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        17344,
        -1184
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, processed: true, urgencia: $json.urgencia, categoria: $json.categoria, respondeu: $json.deve_responder } }}",
        "options": {}
      },
      "id": "9e2be95a-a963-4a9c-914f-96ce2bb08577",
      "name": "12. Responder: Sucesso",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        17568,
        -1696
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "85fc6bde-3b94-45e0-85ab-5db7c2e12be9",
              "leftValue": "={{ $json._photoPriority }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "25a7f452-cfcd-461b-8d75-ce0d35b2184f",
      "name": "3. TEM FOTO?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        10240,
        -1648
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "1c49c630-f708-4b17-a165-d64213fbf33c",
      "name": "4a. Buscar Conversa (FOTO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10464,
        -1760
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $('1. Validar e Processar' ).first().json.patientId }}/diet\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "9ef47fa0-1bb0-42c4-94b0-db7e7953288f",
      "name": "5a. Buscar Dieta (FOTO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10688,
        -1760
      ]
    },
    {
      "parameters": {
        "url": "={{ $('1. Validar e Processar').first().json.attachments[0].url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "binary"
            }
          }
        }
      },
      "id": "13b3048c-b71a-40d8-9c3e-2413f41549c4",
      "name": "6a-1. Baixar Imagem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12256,
        -1760
      ]
    },
    {
      "parameters": {
        "jsCode": "const binaryData = $input.first().binary;\nconst imageKey = Object.keys(binaryData)[0];\nconst base64 = binaryData[imageKey].data;\n\nreturn {\n  json: {\n    imageBase64: base64,\n    mimeType: binaryData[imageKey].mimeType || 'image/jpeg',\n    fileName: binaryData[imageKey].fileName || 'image.jpg'\n  }\n};"
      },
      "id": "1da2c167-28a3-4a61-9a27-9baff3dc420d",
      "name": "6a-2. Converter para Base64",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12480,
        -1760
      ]
    },
    {
      "parameters": {
        "jsCode": "// =============================================================================\n// 8a. COMPARAR COM DIETA - VERSÃƒO CORRIGIDA\n// =============================================================================\n// PROBLEMA ANTERIOR: O cÃ³digo buscava dados do '7a. PARSE-PASSIO' diretamente,\n// ignorando as correÃ§Ãµes feitas pelo '7e-3. Aplicar Dados API'.\n//\n// CORREÃ‡ÃƒO: Agora usa $input.first().json que contÃ©m os dados jÃ¡ corrigidos\n// (seja do 7e-3 ou do 7d-IF quando nÃ£o tem embalagem).\n// =============================================================================\n\n// âœ… CORREÃ‡ÃƒO: Usar o INPUT (que vem do 7e-3 ou 7d-IF)\nconst parseData = $input.first().json;\n\n// Buscar dados da dieta e conversa\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\nconst conversation = $('4a. Buscar Conversa (FOTO)').first().json || {};\n\nconsole.log('=== COMPARANDO COM DIETA/MACROS ===');\nconsole.log('parseData fonte:', parseData.fonte_dados || 'passio');\n\n// Extrair anÃ¡lise da foto (JÃ CORRIGIDA pelo 7e-3 se passou por lÃ¡)\nconst analysisData = parseData.analise_foto || { alimentos: [], macros_totais: {} };\nconst identifiedFoods = analysisData.alimentos || [];\n\nconsole.log('identifiedFoods:', identifiedFoods.length);\nconsole.log('alimentos:', JSON.stringify(identifiedFoods, null, 2));\n\n// Extrair dados da dieta\nconst dietData = dietResponse.data || {};\nconst hasDiet = dietData.meals && Array.isArray(dietData.meals) && dietData.meals.length > 0;\nconst dietSource = hasDiet ? 'prescribed' : 'profile';\n\nconsole.log('hasDiet:', hasDiet);\nconsole.log('dietSource:', dietSource);\n\nlet comparisonResult = {\n  dietSource: dietSource,\n  totalFoods: identifiedFoods.length,\n  approvedFoods: [],\n  unapprovedFoods: [],\n  adherencePercentage: 0,\n  totalMacros: analysisData.macros_totais || {\n    proteinas: 0,\n    carboidratos: 0,\n    gorduras: 0,\n    calorias: 0\n  },\n  dailyMacros: {\n    protein: dietData.dailyProtein || 0,\n    carbs: dietData.dailyCarbs || 0,\n    fats: dietData.dailyFats || 0,\n    calories: dietData.dailyCalories || 0\n  }\n};\n\nconsole.log('totalMacros:', comparisonResult.totalMacros);\nconsole.log('dailyMacros:', comparisonResult.dailyMacros);\n\n// Se tem dieta prescrita com refeiÃ§Ãµes especÃ­ficas\nif (dietSource === 'prescribed' && dietData.meals && dietData.meals.length > 0) {\n  console.log('ðŸ“‹ Comparando com dieta prescrita (refeiÃ§Ãµes especÃ­ficas)');\n  \n  // Extrair todos os alimentos da dieta\n  const dietFoods = [];\n  dietData.meals.forEach(meal => {\n    if (meal.foods && Array.isArray(meal.foods)) {\n      meal.foods.forEach(food => {\n        const foodName = food.name || food.nome || '';\n        if (foodName) {\n          dietFoods.push(foodName.toLowerCase().trim());\n        }\n      });\n    }\n  });\n  \n  console.log('Alimentos na dieta:', dietFoods);\n  \n  // Comparar cada alimento identificado\n  identifiedFoods.forEach(food => {\n    const foodName = (food.nome || '').toLowerCase().trim();\n    const isApproved = dietFoods.some(dietFood => \n      foodName.includes(dietFood) || dietFood.includes(foodName)\n    );\n    \n    if (isApproved) {\n      comparisonResult.approvedFoods.push(food.nome);\n    } else {\n      comparisonResult.unapprovedFoods.push(food.nome);\n    }\n  });\n  \n  // Calcular aderÃªncia\n  if (comparisonResult.totalFoods > 0) {\n    comparisonResult.adherencePercentage = Math.round(\n      (comparisonResult.approvedFoods.length / comparisonResult.totalFoods) * 100\n    );\n  }\n  \n} else if (dietSource === 'profile') {\n  console.log('ðŸ‘¤ Usando macros do perfil (sem refeiÃ§Ãµes especÃ­ficas)');\n  \n  // Quando nÃ£o tem dieta especÃ­fica, nÃ£o podemos comparar alimentos\n  // Mas podemos comparar macros da refeiÃ§Ã£o com macros diÃ¡rios\n  comparisonResult.approvedFoods = identifiedFoods.map(f => f.nome);\n  comparisonResult.unapprovedFoods = [];\n  comparisonResult.adherencePercentage = 100; // NÃ£o hÃ¡ lista para comparar\n  \n  // Adicionar anÃ¡lise de macros\n  const mealProtein = comparisonResult.totalMacros.proteinas || 0;\n  const mealCarbs = comparisonResult.totalMacros.carboidratos || 0;\n  const mealFats = comparisonResult.totalMacros.gorduras || 0;\n  const mealCalories = comparisonResult.totalMacros.calorias || 0;\n  \n  const dailyProtein = comparisonResult.dailyMacros.protein || 0;\n  const dailyCarbs = comparisonResult.dailyMacros.carbs || 0;\n  const dailyFats = comparisonResult.dailyMacros.fats || 0;\n  const dailyCalories = comparisonResult.dailyMacros.calories || 0;\n  \n  // Calcular % do dia que essa refeiÃ§Ã£o representa\n  comparisonResult.macrosPercentage = {\n    protein: dailyProtein > 0 ? Math.round((mealProtein / dailyProtein) * 100) : 0,\n    carbs: dailyCarbs > 0 ? Math.round((mealCarbs / dailyCarbs) * 100) : 0,\n    fats: dailyFats > 0 ? Math.round((mealFats / dailyFats) * 100) : 0,\n    calories: dailyCalories > 0 ? Math.round((mealCalories / dailyCalories) * 100) : 0\n  };\n  \n  console.log('Macros da refeiÃ§Ã£o vs diÃ¡rios:', comparisonResult.macrosPercentage);\n}\n\nconsole.log('âœ… ComparaÃ§Ã£o concluÃ­da');\nconsole.log('AderÃªncia:', comparisonResult.adherencePercentage + '%');\nconsole.log('Aprovados:', comparisonResult.approvedFoods.length);\nconsole.log('NÃ£o aprovados:', comparisonResult.unapprovedFoods.length);\n\nreturn {\n  json: {\n    ...parseData,\n    comparison: comparisonResult,\n    analysisData: analysisData\n  }\n};"
      },
      "id": "62ae3506-77ce-4be0-a1bc-3d3de48a6f21",
      "name": "8a. Comparar com Dieta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15296,
        -1760
      ]
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// NÃ“ 9a. Construir Contexto Resposta - VERSÃƒO MELHORADA\n// =====================================================\n// Resposta dividida em 3 PARTES na ordem correta:\n// PARTE 1: âœ… Registro + O que vocÃª comeu\n// PARTE 2: ðŸ“‹ ComparaÃ§Ã£o com a dieta\n// PARTE 3: ðŸ’¬ Feedback final\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\nconst conversation = $('4a. Buscar Conversa (FOTO)').first().json || {};\n\n// Validar dados\nconst analiseFoto = currentItem.analysisData || { alimentos: [], macros_totais: {} };\nconst comparacao = currentItem.comparison || { \n  totalMacros: {}, \n  dailyMacros: {}, \n  approvedFoods: [], \n  unapprovedFoods: [],\n  adherencePercentage: 0\n};\n\nconsole.log('=== DEBUG ===');\nconsole.log('analiseFoto:', JSON.stringify(analiseFoto, null, 2));\nconsole.log('comparacao:', JSON.stringify(comparacao, null, 2));\n\n// Extrair nome do paciente\nconst patientName = currentItem.patientName || conversation.patientName || 'Paciente';\n\n// Extrair dados da dieta\nconst dietPlan = dietResponse.data || {};\nconst hasDiet = dietPlan.meals && Array.isArray(dietPlan.meals) && dietPlan.meals.length > 0;\n\n// Identificar qual refeiÃ§Ã£o Ã© (baseado no horÃ¡rio)\nconst now = new Date();\nconst hour = now.getHours();\nlet mealType = 'RefeiÃ§Ã£o';\nlet mealTime = `${hour}:${now.getMinutes().toString().padStart(2, '0')}`;\nlet prescribedMeal = null;\n\nif (hasDiet && dietPlan.meals) {\n  if (hour >= 6 && hour < 9) {\n    mealType = 'CafÃ© da ManhÃ£';\n    prescribedMeal = dietPlan.meals.find(m => m.name && m.name.toLowerCase().includes('cafÃ©'));\n  } else if (hour >= 9 && hour < 11) {\n    mealType = 'ColaÃ§Ã£o';\n    prescribedMeal = dietPlan.meals.find(m => m.name && m.name.toLowerCase().includes('colaÃ§Ã£o'));\n  } else if (hour >= 11 && hour < 15) {\n    mealType = 'AlmoÃ§o';\n    prescribedMeal = dietPlan.meals.find(m => m.name && m.name.toLowerCase().includes('almoÃ§o'));\n  } else if (hour >= 15 && hour < 18) {\n    mealType = 'Lanche';\n    prescribedMeal = dietPlan.meals.find(m => m.name && m.name.toLowerCase().includes('lanche'));\n  } else {\n    mealType = 'Jantar';\n    prescribedMeal = dietPlan.meals.find(m => m.name && m.name.toLowerCase().includes('jantar'));\n  }\n}\n\n// Formatar alimentos identificados na foto\nlet foodsIdentified = 'Nenhum alimento identificado';\nif (analiseFoto.alimentos && Array.isArray(analiseFoto.alimentos) && analiseFoto.alimentos.length > 0) {\n  foodsIdentified = analiseFoto.alimentos.map(food => {\n    const peso = food.peso_gramas || 0;\n    const nome = food.nome || 'Alimento';\n    const macros = food.macros || {};\n    const proteinas = macros.proteinas || 0;\n    const carboidratos = macros.carboidratos || 0;\n    const gorduras = macros.gorduras || 0;\n    const calorias = macros.calorias || 0;\n    \n    return `â€¢ ${peso}g ${nome} (${Math.round(proteinas)}g P | ${Math.round(carboidratos)}g C | ${Math.round(gorduras)}g G | ${Math.round(calorias)} kcal)`;\n  }).join('\\n');\n}\n\n// Formatar alimentos prescritos\nlet prescribedFoods = '';\nif (prescribedMeal && prescribedMeal.foods) {\n  prescribedFoods = prescribedMeal.foods.map(food => {\n    const amount = food.amount || food.quantidade || '';\n    const unit = food.unit || food.unidade || 'g';\n    const name = food.name || food.nome || 'Alimento';\n    const protein = food.protein || food.proteinas || (food.macros && food.macros.protein) || 0;\n    const carbs = food.carbs || food.carboidratos || (food.macros && food.macros.carbs) || 0;\n    const fats = food.fats || food.gorduras || (food.macros && food.macros.fats) || 0;\n    const calories = food.calories || food.calorias || (food.macros && food.macros.calories) || 0;\n    \n    return `â€¢ ${amount}${unit} ${name} (${Math.round(protein)}g P | ${Math.round(carbs)}g C | ${Math.round(fats)}g G | ${Math.round(calories)} kcal)`;\n  }).join('\\n');\n}\n\n// Extrair macros da foto\nconst totalMacros = comparacao.totalMacros || analiseFoto.macros_totais || {};\nconst totalProtein = Math.round(totalMacros.proteinas || totalMacros.protein || 0);\nconst totalCarbs = Math.round(totalMacros.carboidratos || totalMacros.carbs || 0);\nconst totalFats = Math.round(totalMacros.gorduras || totalMacros.fats || 0);\nconst totalCalories = Math.round(totalMacros.calorias || totalMacros.calories || 0);\n\n// Extrair macros prescritos\nconst prescribedMacros_obj = prescribedMeal?.macros || prescribedMeal?.totals || {};\nconst prescribedProtein = Math.round(prescribedMacros_obj.protein || prescribedMacros_obj.proteinas || 0);\nconst prescribedCarbs = Math.round(prescribedMacros_obj.carbs || prescribedMacros_obj.carboidratos || 0);\nconst prescribedFats = Math.round(prescribedMacros_obj.fats || prescribedMacros_obj.gorduras || 0);\nconst prescribedCalories = Math.round(prescribedMacros_obj.calories || prescribedMacros_obj.calorias || 0);\n\n// Calcular diferenÃ§as\nconst diffProtein = totalProtein - prescribedProtein;\nconst diffCarbs = totalCarbs - prescribedCarbs;\nconst diffFats = totalFats - prescribedFats;\nconst diffCalories = totalCalories - prescribedCalories;\n\n// Extrair macros diÃ¡rios\nconst dailyMacros = comparacao.dailyMacros || {};\nconst dailyProtein = Math.round(dailyMacros.protein || 0);\nconst dailyCarbs = Math.round(dailyMacros.carbs || 0);\nconst dailyFats = Math.round(dailyMacros.fats || 0);\nconst dailyCalories = Math.round(dailyMacros.calories || 0);\n\n// Construir prompt com 3 PARTES na ordem correta\nconst context = `\nVocÃª Ã© o NutriBuddy, seu assistente inteligente de saÃºde e nutriÃ§Ã£o.\n\nA refeiÃ§Ã£o jÃ¡ foi REGISTRADA AUTOMATICAMENTE no diÃ¡rio do paciente.\n\nðŸ‘¤ PACIENTE: ${patientName}\n\nðŸ“¸ O QUE VOCÃŠ COMEU:\n${foodsIdentified}\n\nðŸ“Š TOTAIS:\nProteÃ­na: ${totalProtein}g | Carboidratos: ${totalCarbs}g | Gorduras: ${totalFats}g | Calorias: ${totalCalories}kcal\n\n${hasDiet && prescribedMeal ? `\nðŸ“‹ COMPARAÃ‡ÃƒO COM SUA DIETA (${mealType.toUpperCase()}):\n${prescribedFoods}\n\nðŸ“Š PREVISTO:\nProteÃ­na: ${prescribedProtein}g | Carboidratos: ${prescribedCarbs}g | Gorduras: ${prescribedFats}g | Calorias: ${prescribedCalories}kcal\n\nðŸ“ˆ DIFERENÃ‡A:\nProteÃ­na: ${diffProtein >= 0 ? '+' : ''}${diffProtein}g\nCarboidratos: ${diffCarbs >= 0 ? '+' : ''}${diffCarbs}g\nGorduras: ${diffFats >= 0 ? '+' : ''}${diffFats}g\nCalorias: ${diffCalories >= 0 ? '+' : ''}${diffCalories}kcal\n` : `\nâš ï¸ Metas diÃ¡rias: ${dailyProtein}g P | ${dailyCarbs}g C | ${dailyFats}g G | ${dailyCalories}kcal\n`}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸŽ¯ FORMATO OBRIGATÃ“RIO - RESPONDA EXATAMENTE ASSIM:\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nPARTE 1 (enviar primeiro):\n---PARTE1---\nâœ… RefeiÃ§Ã£o registrada no diÃ¡rio!\n\nðŸ“¸ O QUE VOCÃŠ COMEU:\n[emoji] Xg [alimento] (Xg P | Xg C | Xg G | X kcal)\n[emoji] Xg [alimento] (Xg P | Xg C | Xg G | X kcal)\n\nðŸ“Š Total: ${totalProtein}g P | ${totalCarbs}g C | ${totalFats}g G | ${totalCalories} kcal\n---FIM1---\n\nPARTE 2 (enviar segundo):\n---PARTE2---\n${hasDiet && prescribedMeal ? `ðŸ“‹ COMPARAÃ‡ÃƒO COM SUA DIETA (${mealType}):\n\nO QUE ESTAVA PRESCRITO:\n[emoji] Xg [alimento] (Xg P | Xg C | Xg G | X kcal)\n[emoji] Xg [alimento] (Xg P | Xg C | Xg G | X kcal)\n\nðŸ“Š Prescrito: ${prescribedProtein}g P | ${prescribedCarbs}g C | ${prescribedFats}g G | ${prescribedCalories} kcal\n\nâš–ï¸ DIFERENÃ‡AS:\n[âœ… ou âš ï¸] ProteÃ­na: +/-Xg\n[âœ… ou âš ï¸] Carboidrato: +/-Xg\n[âœ… ou âš ï¸] Gordura: +/-Xg\n[âœ… ou âš ï¸] Calorias: +/-X kcal` : `ðŸ“Š PERCENTUAL DAS METAS DIÃRIAS:\n\nEsta refeiÃ§Ã£o representa:\nâ€¢ ${dailyProtein > 0 ? Math.round((totalProtein / dailyProtein) * 100) : 0}% da proteÃ­na diÃ¡ria\nâ€¢ ${dailyCarbs > 0 ? Math.round((totalCarbs / dailyCarbs) * 100) : 0}% dos carboidratos diÃ¡rios  \nâ€¢ ${dailyFats > 0 ? Math.round((totalFats / dailyFats) * 100) : 0}% das gorduras diÃ¡rias\nâ€¢ ${dailyCalories > 0 ? Math.round((totalCalories / dailyCalories) * 100) : 0}% das calorias diÃ¡rias`}\n---FIM2---\n\nPARTE 3 (enviar por Ãºltimo):\n---PARTE3---\n${hasDiet && prescribedMeal ? `[Uma frase de feedback baseada na aderÃªncia - ex: \"Ã“tima aderÃªncia Ã  dieta! ðŸ‘\" ou \"Faltou um pouco de proteÃ­na, tente compensar na prÃ³xima. ðŸ’ª\"]` : `ðŸ’¡ Para acompanhamento personalizado e planos detalhados, fale com nossos atendentes ou regularize sua assinatura.`}\n\nSe algo estiver errado na anÃ¡lise, me avise que eu corrijo!\n---FIM3---\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nREGRAS IMPORTANTES:\n1. Use EXATAMENTE os marcadores ---PARTE1---, ---PARTE2---, ---PARTE3---\n2. A PARTE 1 sempre comeÃ§a com \"âœ… RefeiÃ§Ã£o registrada\"\n3. A PARTE 2 sempre tem a comparaÃ§Ã£o ou percentuais\n4. A PARTE 3 sempre tem o feedback final\n5. NÃƒO pergunte se quer registrar (jÃ¡ foi registrado)\n6. NÃƒO pergunte se comeu mais alguma coisa\n7. Use emojis contextuais para os alimentos\n8. Seja preciso com os nÃºmeros\n\nRESPONDA AGORA:\n`;\n\nreturn {\n  json: {\n    ...currentItem,\n    context: context\n  }\n};\n"
      },
      "id": "1d53314e-c2cc-4321-96c1-b2c043e7b382",
      "name": "9a. Construir Contexto Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15520,
        -1760
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o",
          "mode": "list",
          "cachedResultName": "GPT-4O"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.context }}"
            }
          ]
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.7
        }
      },
      "id": "0a69e551-64fa-45dd-930a-3cd0f808b428",
      "name": "10a. IA Gera Resposta",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.3,
      "position": [
        15744,
        -1760
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parse resposta final da IA\nconst currentItem = $('9a. Construir Contexto Resposta').first().json;\nconst aiResponse = $input.first().json.message?.content || $input.first().json.text || '{}';\n\nconsole.log('=== RESPOSTA FINAL IA ===');\nconsole.log(aiResponse);\n\nlet parsed;\ntry {\n  // Remover markdown\n  let jsonText = aiResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  \n  const jsonMatch = jsonText.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    parsed = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('JSON nÃ£o encontrado');\n  }\n} catch (error) {\n  console.error('Erro ao fazer parse da resposta:', error);\n  parsed = {\n    urgencia: 'baixa',\n    sentimento: 'positivo',\n    categoria: 'analise_refeicao',\n    deve_responder: true,\n    resposta: aiResponse\n  };\n}\n\nreturn {\n  json: {\n    ...currentItem,\n    urgencia: parsed.urgencia || 'baixa',\n    sentimento: parsed.sentimento || 'positivo',\n    categoria: parsed.categoria || 'analise_refeicao',\n    deve_responder: parsed.deve_responder !== false,\n    resposta: parsed.resposta || aiResponse\n  }\n};\n"
      },
      "id": "38964186-c2ed-4b3a-b4bb-ebddad1b5b3c",
      "name": "11a. Parse Resposta Final",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16096,
        -1760
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"senderId\": \"{{ $json.senderId }}\",\n  \"senderRole\": \"{{ $json.senderRole }}\",\n  \"content\": {{ JSON.stringify($json.content) }},\n  \"type\": \"{{ $json.type || 'text' }}\",\n  \"isAiGenerated\": true\n}",
        "options": {}
      },
      "id": "8ed8a454-0b57-43a0-8d24-d7ece897b23d",
      "name": "12a. Enviar Resposta (FOTO)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        17344,
        -1760
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $json.patientId }}/profile-macros",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "18334702-9745-4f8f-9deb-f4c833ebd9ed",
      "name": "5b. Buscar Macros Perfil (FALLBACK)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        11584,
        -1664
      ]
    },
    {
      "parameters": {
        "jsCode": "// Verificar se tem dieta prescrita ou usar macros do perfil\nconst dietResponse = $input.first().json;\n\nconsole.log('=== VERIFICANDO DIETA ===');\nconsole.log('Diet response:', JSON.stringify(dietResponse, null, 2));\n\n// Verificar se tem dieta ativa\nconst hasDiet = dietResponse.data && \n                dietResponse.data.meals && \n                Array.isArray(dietResponse.data.meals) && \n                dietResponse.data.meals.length > 0;\n\nconsole.log('Has diet?', hasDiet);\n\nreturn {\n  json: {\n    hasDiet: hasDiet,\n    dietData: dietResponse.data || {}\n  }\n};\n"
      },
      "id": "b1b77f5b-881b-4ea3-98a4-7796517e3c7d",
      "name": "5c. Tem Dieta Prescrita?",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11136,
        -1760
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasDiet }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "1b3c6767-f2b7-4683-aa24-8237d0b38815",
      "name": "5d. IF: Tem Dieta?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        11360,
        -1760
      ]
    },
    {
      "parameters": {
        "jsCode": "// Usar dieta prescrita\nconst currentItem = $('1. Validar e Processar').first().json;\nconst dietData = $input.first().json.dietData;\n\nconsole.log('=== USANDO DIETA PRESCRITA ===');\n\nreturn {\n  json: {\n    ...currentItem,\n    dietSource: 'prescribed',\n    dietPlan: {\n      name: dietData.name || 'Dieta Prescrita',\n      description: dietData.description || '',\n      meals: dietData.meals || [],\n      dailyProtein: dietData.macros?.protein || 0,\n      dailyCarbs: dietData.macros?.carbs || 0,\n      dailyFats: dietData.macros?.fats || 0,\n      dailyCalories: dietData.macros?.calories || 0\n    }\n  }\n};\n"
      },
      "id": "518f54d8-4228-4523-9a90-0bc83e54e11f",
      "name": "5e. Usar Dieta Prescrita",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11808,
        -1856
      ]
    },
    {
      "parameters": {
        "jsCode": "// Usar macros do perfil (fallback)\nconst currentItem = $('1. Validar e Processar').first().json;\nconst profileResponse = $('5b. Buscar Macros Perfil (FALLBACK)').first().json;\n\nconsole.log('=== USANDO MACROS DO PERFIL (FALLBACK) ===');\nconsole.log('Profile response:', JSON.stringify(profileResponse, null, 2));\n\nconst profileData = profileResponse.data || {};\n\nreturn {\n  json: {\n    ...currentItem,\n    dietSource: 'profile',\n    dietPlan: {\n      name: profileData.name || 'Macros do Perfil',\n      description: profileData.description || 'Macronutrientes baseados no perfil do paciente',\n      meals: [], // Sem refeiÃ§Ãµes especÃ­ficas\n      dailyProtein: profileData.macros?.protein || 0,\n      dailyCarbs: profileData.macros?.carbs || 0,\n      dailyFats: profileData.macros?.fats || 0,\n      dailyCalories: profileData.macros?.calories || 0,\n      patientInfo: profileData.patientInfo || {}\n    }\n  }\n};\n"
      },
      "id": "327fceea-a893-46bd-87ab-322c7b7cc06c",
      "name": "5f. Usar Macros do Perfil",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11808,
        -1664
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "18ebc220-e535-4666-adb6-adc9a0519d76",
      "name": "FASE2: 2. Buscar Contexto Ativo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13376,
        240
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasContext }}",
              "value2": true
            }
          ]
        },
        "options": {}
      },
      "id": "00514923-e91d-406b-afd5-afd46c3f9102",
      "name": "FASE2: 3. Tem Contexto Ativo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        13600,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// Processar adiÃ§Ã£o de novo alimento\nconst currentItem = $input.first().json;\nconst context = currentItem.context;\nconst userMessage = currentItem.intention.userMessage;\n\nconsole.log('Processando adiÃ§Ã£o:', userMessage);\n\n// Extrair alimento e peso da mensagem\nconst numbers = userMessage.match(/\\d+/g);\nconst weight = numbers && numbers.length > 0 ? parseInt(numbers[0]) : 100;\n\n// Tentar identificar o alimento\nlet foodName = 'Alimento adicional';\nconst commonFoods = {\n  'arroz': { protein: 0.026, carbs: 0.28, fats: 0.003, calories: 1.3 },\n  'feijÃ£o': { protein: 0.09, carbs: 0.23, fats: 0.005, calories: 1.27 },\n  'frango': { protein: 0.31, carbs: 0, fats: 0.036, calories: 1.65 },\n  'carne': { protein: 0.26, carbs: 0, fats: 0.15, calories: 2.5 },\n  'peixe': { protein: 0.22, carbs: 0, fats: 0.05, calories: 1.2 },\n  'salada': { protein: 0.01, carbs: 0.03, fats: 0.002, calories: 0.2 },\n  'batata': { protein: 0.02, carbs: 0.17, fats: 0.001, calories: 0.77 },\n  'macarrÃ£o': { protein: 0.05, carbs: 0.25, fats: 0.009, calories: 1.31 }\n};\n\nlet macrosPer100g = { protein: 0.05, carbs: 0.25, fats: 0.02, calories: 1.5 };\n\nfor (const [food, macros] of Object.entries(commonFoods)) {\n  if (userMessage.includes(food)) {\n    foodName = food.charAt(0).toUpperCase() + food.slice(1);\n    macrosPer100g = macros;\n    break;\n  }\n}\n\n// Calcular macros do novo alimento\nconst newFood = {\n  name: foodName,\n  weight: weight,\n  macros: {\n    protein: Math.round(weight * macrosPer100g.protein * 10) / 10,\n    carbs: Math.round(weight * macrosPer100g.carbs * 10) / 10,\n    fats: Math.round(weight * macrosPer100g.fats * 10) / 10,\n    calories: Math.round(weight * macrosPer100g.calories)\n  }\n};\n\n// Adicionar ao contexto\nconst updatedFoods = [...context.data.foods, newFood];\n\n// Recalcular totais\nconst totalMacros = updatedFoods.reduce((acc, food) => ({\n  protein: acc.protein + food.macros.protein,\n  carbs: acc.carbs + food.macros.carbs,\n  fats: acc.fats + food.macros.fats,\n  calories: acc.calories + food.macros.calories\n}), { protein: 0, carbs: 0, fats: 0, calories: 0 });\n\nreturn {\n  json: {\n    conversationId: currentItem.conversationId,\n    action: 'update',\n    contextUpdate: {\n      data: {\n        ...context.data,\n        foods: updatedFoods,\n        totalMacros: {\n          protein: Math.round(totalMacros.protein * 10) / 10,\n          carbs: Math.round(totalMacros.carbs * 10) / 10,\n          fats: Math.round(totalMacros.fats * 10) / 10,\n          calories: Math.round(totalMacros.calories)\n        }\n      }\n    },\n    responseMessage: `Ã“timo! Adicionei ${foodName} (${weight}g) Ã  sua refeiÃ§Ã£o. \n\nðŸ“Š Novo total:\n- ProteÃ­na: ${Math.round(totalMacros.protein)}g\n- Carboidratos: ${Math.round(totalMacros.carbs)}g\n- Gorduras: ${Math.round(totalMacros.fats)}g\n- Calorias: ${Math.round(totalMacros.calories)}\n\nTem mais alguma coisa? ðŸ¤”`\n  }\n};"
      },
      "id": "4fc91428-685d-4d4f-b11f-5b1b0e9b6e5a",
      "name": "FASE2: 6b. AÃ§Ã£o: AdiÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15520,
        -1008
      ]
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// FASE2: 6c. AÃ‡ÃƒO: CONFIRMAÃ‡ÃƒO (V2 - COM SALVAMENTO)\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst context = currentItem.context || {};\nconst contextData = context.data || {};\n\nconsole.log('âœ… Confirmando registro:', contextData);\n\n// =====================================================\n// ðŸ”¥ EXTRAIR FEEDBACKS PENDENTES PARA SALVAR\n// =====================================================\nconst pendingFeedbacks = contextData.pendingFeedbacks || [];\nconsole.log(`ðŸ“Š Feedbacks pendentes: ${pendingFeedbacks.length}`);\n\n// Preparar sugestÃµes para enviar ao Calibration Studio\nconst suggestionsToSave = pendingFeedbacks.map(f => ({\n  patientId: currentItem.patientId,\n  foodName: f.foodName,\n  foodType: f.foodType,\n  aiEstimate: f.aiEstimate,\n  userCorrection: f.userCorrection,\n  conversationId: currentItem.conversationId\n}));\n\n// Montar mensagem de resposta\nlet resposta = 'Perfeito! Registrando sua refeiÃ§Ã£o... âœ…';\n\nif (pendingFeedbacks.length > 0) {\n  resposta = `âœ… RefeiÃ§Ã£o registrada com ${pendingFeedbacks.length} ajuste(s) de peso!\\n\\nSeu feedback foi enviado para anÃ¡lise do nutricionista. ðŸ’ª`;\n}\n\n// =====================================================\n// RETORNO\n// =====================================================\nreturn {\n  json: {\n    conversationId: currentItem.conversationId,\n    patientId: currentItem.patientId,\n    prescriberId: currentItem.prescriberId,\n    action: 'confirm_and_save',\n    \n    // Dados da refeiÃ§Ã£o\n    mealData: {\n      patientId: currentItem.patientId,\n      conversationId: currentItem.conversationId,\n      ...contextData\n    },\n    \n    // ðŸ”¥ SUGESTÃ•ES PARA O CALIBRATION STUDIO\n    suggestionsToSave: suggestionsToSave,\n    hasSuggestions: suggestionsToSave.length > 0,\n    suggestionCount: suggestionsToSave.length,\n    \n    // Resposta ao paciente\n    responseMessage: resposta\n  }\n};"
      },
      "id": "ea478a7d-cb5f-414a-9aa4-c939aa038134",
      "name": "FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14624,
        -768
      ]
    },
    {
      "parameters": {
        "jsCode": "// Cancelar registro\nconst currentItem = $input.first().json;\n\nconsole.log('Cancelando registro');\n\nreturn {\n  json: {\n    conversationId: currentItem.conversationId,\n    action: 'cancel',\n    responseMessage: 'Tudo bem! Cancelei o registro. Se quiser registrar depois, Ã© sÃ³ me avisar! ðŸ˜Š'\n  }\n};"
      },
      "id": "59998495-3a48-48cc-8cab-084582d06016",
      "name": "FASE2: 6d. AÃ§Ã£o: Cancelamento",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15520,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/meals/confirm",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-webhook-secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($('FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o').first().json.mealData) }}",
        "options": {}
      },
      "id": "ad711841-0df3-49e7-8212-42f233b8c90a",
      "name": "FASE2: 8. Registrar RefeiÃ§Ã£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        15520,
        -768
      ]
    },
    {
      "parameters": {
        "method": "DELETE",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar').first().json.conversationId }}/context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "ed1cbcd2-8822-4253-9080-fb99a1c5652d",
      "name": "FASE2: 9. Deletar Contexto",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        15808,
        -432
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $('1. Validar e Processar').first().json.conversationId }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  senderId: 'system',\n  senderRole: 'prescriber',\n  content: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.responseMessage || 'âœ… RefeiÃ§Ã£o registrada com sucesso! JÃ¡ atualizei seu diÃ¡rio.',\n  type: 'text',\n  isAiGenerated: true\n}) }}",
        "options": {}
      },
      "id": "57f9661d-3889-4284-a49b-ff9b13549d10",
      "name": "FASE2: 10. Enviar Resposta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        16096,
        -144
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { success: true, action: $json.action || 'response_sent' } }}",
        "options": {}
      },
      "id": "5586d2f1-cdbe-45c5-9ce0-4f67319e8b94",
      "name": "FASE2: 11. Responder Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        16320,
        -144
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "audio-check-1",
              "leftValue": "={{ $json.type }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5a36a4c0-247a-4eaf-bfcd-814c44f9baca",
      "name": "2a. TEM ÃUDIO?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        13152,
        -576
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.mediaUrl && $json.mediaUrl.startsWith('http') ? $json.mediaUrl : ($json.attachments && $json.attachments[0] && $json.attachments[0].url && $json.attachments[0].url.startsWith('http') ? $json.attachments[0].url : 'http://placeholder-error-url') }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "9f9cc666-97de-428e-a274-e1f0d7f30063",
      "name": "AUDIO: 1. Baixar Arquivo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13376,
        16
      ],
      "binaryPropertyName": "data",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Ã¡udio para Whisper\nconst currentItem = $('1. Validar e Processar').first().json;\n// Binary data vem do nÃ³ HTTP request\nconst binaryData = $input.first().binary;\n\nconsole.log('=== PREPARANDO ÃUDIO ===');\n\n// Extrair URL de forma segura\nconst audioUrl = currentItem.mediaUrl || (currentItem.attachments && currentItem.attachments[0] ? currentItem.attachments[0].url : 'URL_NAO_ENCONTRADA');\nconsole.log('URL do Ã¡udio:', audioUrl);\n\n// Verificar se temos dados binÃ¡rios\nif (!binaryData || !binaryData.data) {\n  console.error('âŒ ERRO: Nenhum dado binÃ¡rio recebido do download');\n  // Retornar erro controlado em vez de lanÃ§ar exceÃ§Ã£o\n  return {\n    json: {\n      ...currentItem,\n      error: 'Falha no download do Ã¡udio',\n      audioUrl: audioUrl\n    }\n  };\n}\n\n// ðŸ”¥ TRUQUE CRÃTICO: A OpenAI API exige que o arquivo tenha extensÃ£o vÃ¡lida no nome\nconst originalFileName = binaryData.data.fileName || 'audio_whatsapp';\nconst newFileName = 'audio_' + Date.now() + '.ogg';\n\nconsole.log('Renomeando de', originalFileName, 'para', newFileName);\n\nreturn {\n  json: {\n    ...currentItem,\n    audioUrl: audioUrl\n  },\n  binary: {\n    data: {\n      ...binaryData.data,\n      fileName: newFileName,\n      fileExtension: 'ogg',\n      mimeType: 'audio/ogg'\n    }\n  }\n};"
      },
      "id": "f02197c0-f87b-44ed-85aa-792a8aa379c2",
      "name": "AUDIO: 2. Preparar para Whisper",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13600,
        16
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse transcriÃ§Ã£o do Whisper\n// Garantir que pegamos o conversationId de qualquer fonte disponÃ­vel\nlet currentItem = {};\ntry {\n  currentItem = $('1. Validar e Processar').first().json || {};\n} catch (e) {\n  // Se nÃ£o conseguir pegar do nÃ³ inicial, tenta do input\n  currentItem = $input.first().json || {};\n}\n\nconst whisperOutput = $input.first().json;\n\nconsole.log('=== TRANSCRIÃ‡ÃƒO RECEBIDA ===');\nconsole.log('Current item conversationId:', currentItem.conversationId);\nconsole.log('Whisper output:', whisperOutput);\n\nlet transcricao = '';\nlet erroTranscricao = false;\n\n// Verificar se houve erro no Whisper\nif (whisperOutput.error) {\n  console.error('âŒ Erro no Whisper:', whisperOutput.error);\n  transcricao = '[ERRO NA TRANSCRIÃ‡ÃƒO: NÃ£o foi possÃ­vel converter o Ã¡udio em texto]';\n  erroTranscricao = true;\n} else {\n  // A transcriÃ§Ã£o vem na propriedade text\n  transcricao = whisperOutput.text ? whisperOutput.text.trim() : '';\n}\n\nif (!transcricao) {\n  transcricao = '[Ãudio vazio ou inaudÃ­vel]';\n}\n\nconsole.log('Texto final:', transcricao);\n\n// Garantir que conversationId e patientId estÃ£o presentes\nif (!currentItem.conversationId) {\n  console.error('âŒ ERRO CRÃTICO: conversationId nÃ£o encontrado!');\n  console.error('Current item:', JSON.stringify(currentItem, null, 2));\n}\n\n// Atualizar content com a transcriÃ§Ã£o\nreturn {\n  json: {\n    ...currentItem,\n    content: transcricao,\n    originalContent: currentItem.content || '',\n    type: 'text',\n    isTranscribed: true,\n    transcriptionError: erroTranscricao,\n    // Garantir que conversationId e patientId estÃ£o presentes\n    conversationId: currentItem.conversationId || '',\n    patientId: currentItem.patientId || currentItem.senderId || ''\n  }\n};\n"
      },
      "id": "e31bb765-0713-4e3e-890a-9bfe98d57691",
      "name": "AUDIO: 4. Parse TranscriÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14176,
        16
      ]
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        13888,
        16
      ],
      "id": "83f6d721-0db2-45cb-bea1-53bc0f313409",
      "name": "Transcribe a recording",
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// NÃ“ 11b. Dividir em 3 Mensagens - VERSÃƒO INTELIGENTE\n// =====================================================\n// Envia comparaÃ§Ã£o automÃ¡tica sÃ³ entre 20h e 00h\n// Ou quando paciente solicitar\n// =====================================================\n\nconst dados = $input.first().json;\nconst dadosIA = $('11a. Parse Resposta Final').first().json;\nconst respostaCompleta = dadosIA.resposta || '';\n\nconst senderId = dados.prescriberId || dadosIA.prescriberId || '6yooHer7ZgYOcYe0JHkXHLnWBq83';\nconst conversationId = dados.conversationId || dadosIA.conversationId;\n\n// =====================================================\n// VERIFICAR HORÃRIO PARA DECIDIR SE ENVIA COMPARAÃ‡ÃƒO\n// =====================================================\n\nconst agora = new Date();\nconst horaAtual = agora.getHours();\n\n// Envia comparaÃ§Ã£o automÃ¡tica entre 20h e 23h59\nconst enviarComparacaoAutomatica = horaAtual >= 20 || horaAtual < 0;\n\nconsole.log(`â° Hora atual: ${horaAtual}h`);\nconsole.log(`ðŸ“Š Enviar comparaÃ§Ã£o automÃ¡tica: ${enviarComparacaoAutomatica}`);\n\n// =====================================================\n// VALIDAÃ‡ÃƒO\n// =====================================================\n\nif (!respostaCompleta) {\n  console.error('ERRO: Resposta da IA nÃ£o encontrada!');\n  return [{\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: 'âŒ Erro ao processar anÃ¡lise. Tente novamente.',\n      type: 'text',\n      conversationId: conversationId\n    }\n  }];\n}\n\nconsole.log('=== RESPOSTA COMPLETA DA IA ===');\nconsole.log(respostaCompleta);\n\n// =====================================================\n// EXTRAIR PARTES E LIMPAR MARCADORES\n// =====================================================\n\nlet parte1 = '';\nlet parte2 = '';\nlet parte3 = '';\n\nconst regexParte1 = /---PARTE1---([\\s\\S]*?)---FIM1---/;\nconst regexParte2 = /---PARTE2---([\\s\\S]*?)---FIM2---/;\nconst regexParte3 = /---PARTE3---([\\s\\S]*?)---FIM3---/;\n\nconst matchParte1 = respostaCompleta.match(regexParte1);\nconst matchParte2 = respostaCompleta.match(regexParte2);\nconst matchParte3 = respostaCompleta.match(regexParte3);\n\nif (matchParte1) parte1 = matchParte1[1].trim();\nif (matchParte2) parte2 = matchParte2[1].trim();\nif (matchParte3) parte3 = matchParte3[1].trim();\n\n// Fallback se nÃ£o encontrou marcadores\nif (!matchParte1 && !matchParte2 && !matchParte3) {\n  let respostaLimpa = respostaCompleta\n    .replace(/---PARTE\\d---/g, '')\n    .replace(/---FIM\\d---/g, '')\n    .trim();\n  parte1 = respostaLimpa;\n}\n\n// =====================================================\n// LIMPAR MARCADORES RESIDUAIS\n// =====================================================\n\nconst limparMarcadores = (texto) => {\n  if (!texto) return '';\n  return texto\n    .replace(/---PARTE\\d---/g, '')\n    .replace(/---FIM\\d---/g, '')\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .trim();\n};\n\nparte1 = limparMarcadores(parte1);\nparte2 = limparMarcadores(parte2);\nparte3 = limparMarcadores(parte3);\n\n// =====================================================\n// GARANTIR CONFIRMAÃ‡ÃƒO NO INÃCIO\n// =====================================================\n\nif (parte1 && !parte1.startsWith('âœ…')) {\n  parte1 = 'âœ… RefeiÃ§Ã£o registrada no diÃ¡rio!\\n\\n' + parte1;\n}\n\n// =====================================================\n// MENSAGEM DE FEEDBACK\n// =====================================================\n\nconst feedbackPadrao = 'ðŸ’¬ Algo errado? Me diga que eu aprendo!';\n\nif (!parte3) {\n  parte3 = feedbackPadrao;\n} else if (!parte3.includes('errado') && !parte3.includes('corrij') && !parte3.includes('aprendo')) {\n  parte3 = parte3 + '\\n\\n' + feedbackPadrao;\n}\n\n// =====================================================\n// CONSTRUIR MENSAGENS\n// =====================================================\n\nconst mensagens = [];\n\n// MENSAGEM 1: Registro + O que vocÃª comeu (SEMPRE)\nif (parte1) {\n  mensagens.push({\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: parte1,\n      type: 'text',\n      order: 1,\n      totalMessages: enviarComparacaoAutomatica ? 3 : 2,\n      conversationId: conversationId\n    }\n  });\n}\n\n// MENSAGEM 2: ComparaÃ§Ã£o com dieta (SÃ“ ENTRE 20h E 00h)\nif (parte2 && parte2.length > 10 && enviarComparacaoAutomatica) {\n  mensagens.push({\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: parte2,\n      type: 'text',\n      order: 2,\n      totalMessages: 3,\n      conversationId: conversationId\n    }\n  });\n  console.log('ðŸ“Š ComparaÃ§Ã£o enviada (horÃ¡rio noturno)');\n} else if (parte2 && !enviarComparacaoAutomatica) {\n  console.log('ðŸ“Š ComparaÃ§Ã£o NÃƒO enviada (fora do horÃ¡rio 20h-00h)');\n}\n\n// MENSAGEM 3: Feedback final (SEMPRE)\nif (parte3) {\n  mensagens.push({\n    json: {\n      senderId: senderId,\n      senderRole: 'prescriber',\n      content: parte3,\n      type: 'text',\n      order: mensagens.length + 1,\n      totalMessages: mensagens.length + 1,\n      conversationId: conversationId\n    }\n  });\n}\n\nconsole.log(`âœ… Retornando ${mensagens.length} mensagens`);\nreturn mensagens;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        17120,
        -1760
      ],
      "id": "a9d8b172-3ad3-4651-b8bb-23985a673e9f",
      "name": "11b. Dividir em 3 Mensagens"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 5h. Detectar Pergunta sobre HistÃ³rico/Dieta\n// =====================================================\n// Detecta perguntas sobre histÃ³rico E sobre dieta prescrita\n// =====================================================\n\nconst mensagem = $input.first().json.content || '';\nconst mensagemLower = mensagem.toLowerCase()\n  .normalize('NFD')\n  .replace(/[\\u0300-\\u036f]/g, ''); // Remove acentos\n\n// Palavras-chave de HISTÃ“RICO\nconst palavrasHistorico = [\n  'o que eu comi',\n  'o que comi',\n  'ja comi',\n  'ja registrei',\n  'registrei',\n  'quanto de proteina',\n  'quantas calorias',\n  'quanto de carboidrato',\n  'quanto de gordura',\n  'ontem',\n  'semana passada',\n  'nos ultimos dias',\n  'historico',\n  'diario',\n  'refeicoes anteriores',\n  'ja consumi',\n  'total do dia',\n  'total de hoje'\n];\n\n// Palavras-chave de COMPARAÃ‡ÃƒO COM DIETA\nconst palavrasDieta = [\n  'comparacao',\n  'comparar',\n  'comparando',\n  'dieta prescrita',\n  'minha dieta',\n  'em relacao a dieta',\n  'meta',\n  'minha meta',\n  'como estou',\n  'como to',\n  'como ta',\n  'falta comer',\n  'falta quanto',\n  'quanto falta',\n  'restante',\n  'sobrou',\n  'passei',\n  'excedi',\n  'estourei',\n  'ultrapassei',\n  'balanco',\n  'resumo do dia',\n  'fechamento',\n  'como foi meu dia',\n  'comi bem',\n  'comi mal',\n  'ta bom',\n  'ta ruim'\n];\n\n// Palavras que indicam \"hoje\"\nconst palavrasHoje = [\n  'hoje',\n  'agora',\n  'ate agora',\n  'ate aqui',\n  'no momento'\n];\n\nconst isPerguntaHistorico = palavrasHistorico.some(p => mensagemLower.includes(p));\nconst isPerguntaDieta = palavrasDieta.some(p => mensagemLower.includes(p));\nconst mencionaHoje = palavrasHoje.some(p => mensagemLower.includes(p));\n\n// Se pergunta sobre dieta/comparaÃ§Ã£o + hoje = buscar histÃ³rico de hoje\nconst deveCompararComDieta = isPerguntaDieta || (isPerguntaHistorico && mencionaHoje);\n\nconsole.log('ðŸ“ Mensagem:', mensagem);\nconsole.log('ðŸ“Š Ã‰ pergunta sobre histÃ³rico:', isPerguntaHistorico);\nconsole.log('ðŸŽ¯ Ã‰ pergunta sobre dieta:', isPerguntaDieta);\nconsole.log('ðŸ“… Menciona hoje:', mencionaHoje);\nconsole.log('âš–ï¸ Deve comparar com dieta:', deveCompararComDieta);\n\nreturn [{\n  json: {\n    ...$input.first().json,\n    isPerguntaHistorico: isPerguntaHistorico || isPerguntaDieta,\n    isPerguntaDieta: isPerguntaDieta,\n    deveCompararComDieta: deveCompararComDieta,\n    mensagemOriginal: mensagem\n  }\n}];"
      },
      "id": "e056d9a7-54bb-4233-bf75-37c1918481e3",
      "name": "5h. Detectar Pergunta sobre HistÃ³rico",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15072,
        -1280
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "771a921c-4b71-40da-b8d2-89e0ec6535ec",
              "leftValue": "={{ $json.isPerguntaHistorico }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "31bc6e9d-9639-429a-ac48-17f8ab5ff812",
      "name": "5h-IF. Ã‰ Pergunta sobre HistÃ³rico?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        15296,
        -1280
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extrair perÃ­odo da pergunta\nconst mensagem = $input.first().json.mensagemOriginal.toLowerCase();\nconst hoje = new Date();\n\nfunction formatDate(date) {\n  const year = date.getFullYear();\n  const month = String(date.getMonth() + 1).padStart(2, '0');\n  const day = String(date.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\n\nfunction subtractDays(date, days) {\n  const result = new Date(date);\n  result.setDate(result.getDate() - days);\n  return result;\n}\n\nlet startDate, endDate, periodo;\n\nif (mensagem.includes('hoje')) {\n  startDate = formatDate(hoje);\n  endDate = formatDate(hoje);\n  periodo = 'hoje';\n  \n} else if (mensagem.includes('ontem')) {\n  const ontem = subtractDays(hoje, 1);\n  startDate = formatDate(ontem);\n  endDate = formatDate(ontem);\n  periodo = 'ontem';\n  \n} else if (mensagem.includes('essa semana') || mensagem.includes('esta semana')) {\n  const inicioSemana = subtractDays(hoje, hoje.getDay());\n  startDate = formatDate(inicioSemana);\n  endDate = formatDate(hoje);\n  periodo = 'essa semana';\n  \n} else if (mensagem.includes('semana passada')) {\n  const fimSemanaPassada = subtractDays(hoje, hoje.getDay());\n  const inicioSemanaPassada = subtractDays(fimSemanaPassada, 7);\n  startDate = formatDate(inicioSemanaPassada);\n  endDate = formatDate(fimSemanaPassada);\n  periodo = 'semana passada';\n  \n} else if (mensagem.includes('Ãºltimos 7 dias') || mensagem.includes('ultima semana')) {\n  startDate = formatDate(subtractDays(hoje, 7));\n  endDate = formatDate(hoje);\n  periodo = 'Ãºltimos 7 dias';\n  \n} else if (mensagem.includes('Ãºltimos 3 dias')) {\n  startDate = formatDate(subtractDays(hoje, 3));\n  endDate = formatDate(hoje);\n  periodo = 'Ãºltimos 3 dias';\n  \n} else {\n  // PadrÃ£o: hoje\n  startDate = formatDate(hoje);\n  endDate = formatDate(hoje);\n  periodo = 'hoje';\n}\n\nreturn [{\n  json: {\n    ...$input.first().json,\n    startDate: startDate,\n    endDate: endDate,\n    periodo: periodo,\n    isSingleDay: startDate === endDate\n  }\n}];"
      },
      "id": "9fc4a38a-1548-4f22-aec5-09bb5ef571c5",
      "name": "5i. Extrair PerÃ­odo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15520,
        -1504
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patients/{{ $('1. Validar e Processar').first().json.patientId }}/food-diary?startDate={{ $json.startDate }}&endDate={{ $json.endDate }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "id": "95ff953e-2015-44ce-9c87-dba9ae6a9b33",
      "name": "5j. Buscar HistÃ³rico DiÃ¡rio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        15808,
        -1504
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Construir contexto com histÃ³rico do diÃ¡rio\nconst dados = $input.first().json;\nconst historicoResponse = $('5j. Buscar HistÃ³rico DiÃ¡rio').first().json;\n\nconst periodo = dados.periodo || 'hoje';\nconst logs = historicoResponse.logs || [];\nconst summary = historicoResponse.summary || {};\n\n// Formatar logs do diÃ¡rio\nlet historicoFormatado = '';\n\nif (logs.length === 0) {\n  historicoFormatado = `\\nðŸ“­ HISTÃ“RICO DO DIÃRIO (${periodo}):\\nNenhuma refeiÃ§Ã£o registrada neste perÃ­odo.\\n`;\n} else {\n  const logsFormatados = logs.map(log => {\n    const tipo = log.type || 'refeiÃ§Ã£o';\n    const data = log.date || '';\n    const hora = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';\n    const descricao = log.description || '';\n    const alimentos = (log.foods || []).join(', ');\n    const macros = log.macros || {};\n    \n    return `\nðŸ½ï¸ ${tipo.toUpperCase()} - ${data} ${hora}\n   Alimentos: ${alimentos || descricao}\n   ðŸ“Š ${Math.round(macros.calories || 0)}kcal | P:${Math.round(macros.protein || 0)}g | C:${Math.round(macros.carbs || 0)}g | G:${Math.round(macros.fats || 0)}g\n   ${log.userComment ? `ðŸ’¬ \"${log.userComment}\"` : ''}`;\n  }).join('\\n');\n\n  historicoFormatado = `\nðŸ“š HISTÃ“RICO DO DIÃRIO ALIMENTAR (${periodo}):\n\n${logsFormatados}\n\nðŸ“Š RESUMO TOTAL DO PERÃODO:\n- Calorias: ${Math.round(summary.totalCalories || 0)} kcal\n- ProteÃ­nas: ${Math.round(summary.totalProtein || 0)}g\n- Carboidratos: ${Math.round(summary.totalCarbs || 0)}g\n- Gorduras: ${Math.round(summary.totalFats || 0)}g\n- Total de refeiÃ§Ãµes: ${logs.length}\n`;\n}\n\nreturn [{\n  json: {\n    ...dados,\n    historicoFormatado: historicoFormatado,\n    temHistorico: logs.length > 0,\n    totalRefeicoes: logs.length,\n    summaryMacros: summary\n  }\n}];"
      },
      "id": "50e25899-c12c-4ad9-8e5b-101edbeeef1b",
      "name": "5k. Construir Contexto com HistÃ³rico",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16096,
        -1504
      ]
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/conversations/{{ $json.conversationId }}/context\n",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        13376,
        -1472
      ],
      "id": "aa574395-f10a-4b36-8c20-8a523e4f81a7",
      "name": "3a. Tem Contexto FASE2?",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "11083c60-ee7f-4a84-8248-6115f479d7af",
              "leftValue": "={{ $json.hasContext }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        13600,
        -1472
      ],
      "id": "5a2707cc-0d0e-41db-9b8f-d0193c869659",
      "name": "3b. IF: Tem Dados?"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6284723a-47e4-4d2c-a474-a2b8f0acf81f",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "addition",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "confirmation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c0e8dc2c-5324-4c32-95a4-3b8b9ec1d93f"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d58b4d7f-2655-487f-b384-8ac42c5e0ae9",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "correction",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9c1a1a27-a333-4493-ae7c-c1e3e7cb046f",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "cancellation",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "340633a4-507c-4736-b77a-fc8a09cf2815",
                    "leftValue": "={{ $json.intention.type }}",
                    "rightValue": "history_query",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        14400,
        -832
      ],
      "id": "502dcae2-0ab6-40db-978c-7d94dce1b4cd",
      "name": "Roteador de IntenÃ§Ã£o"
    },
    {
      "parameters": {
        "url": "=https://web-production-c9eaf.up.railway.app/api/n8n/patient/{{ $('1. Validar e Processar').first().json.patientId }}/full-context",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "x-webhook-secret",
              "value": "=nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        16096,
        -1184
      ],
      "id": "fa263855-641c-40ff-8468-e36fe25823f1",
      "name": "5z. Buscar Contexto Completo do Paciente"
    },
    {
      "parameters": {
        "jsCode": "// 7d. DETECTAR EMBALAGEM E PREPARAR BUSCA\nconst item = $input.first().json;\nconst alimentos = item.analise_foto?.alimentos || [];\nconst imageUrl = item.imageUrl || item.attachments?.[0]?.url || $('1. Validar e Processar').first().json.attachments?.[0]?.url || '';\n\n// Palavras que indicam produto embalado\nconst embalagem = [\n  'yogurt', 'iogurte', 'activia', 'danone', 'nestle', 'nestlÃ©',\n  'leite', 'suco', 'juice', 'milk', 'yakult', 'danoninho',\n  'vigor', 'batavo', 'itambÃ©', 'piracanjuba', 'elegÃª',\n  'barra', 'bar', 'cereal', 'granola', 'nescau', 'toddy',\n  'biscoito', 'cookie', 'bolacha', 'cream cheese', 'requeijÃ£o',\n  'refrigerante', 'soda', 'coca', 'pepsi', 'guaranÃ¡'\n];\n\n// Verificar se algum alimento Ã© produto embalado\nconst produtosEmbalados = alimentos.filter(a => {\n  const nome = ((a.nome || '') + (a.nome_original || '')).toLowerCase();\n  return embalagem.some(p => nome.includes(p));\n});\n\nconst temEmbalagem = produtosEmbalados.length > 0;\n\nconsole.log('ðŸ“¦ Produtos embalados:', produtosEmbalados.length);\n\nif (!temEmbalagem) {\n  console.log('âœ… Sem produtos embalados. Passando direto.');\n  return { \n    json: { \n      ...item, \n      tem_embalagem: false,\n      pular_busca: true\n    } \n  };\n}\n\n// Preparar prompt para Vision ler a embalagem\nconst nomesEmbalados = produtosEmbalados.map(a => a.nome || a.nome_original).join(', ');\n\nconst prompt = `Analise esta foto e LEIA O TEXTO NA EMBALAGEM do produto.\n\nðŸŽ¯ OBJETIVO: Identificar o produto EXATO lendo a embalagem.\n\nO QUE PROCURAR:\n1. MARCA (ex: Activia, Danone, NestlÃ©)\n2. LINHA/VERSÃƒO (ex: Triplo Zero, Light, Integral)\n3. SABOR (ex: Ameixa, Morango, Natural)\n4. PESO/VOLUME (ex: 170g, 200ml)\n5. CÃ“DIGO DE BARRAS (se visÃ­vel)\n\nðŸ“¦ PRODUTO DETECTADO: ${nomesEmbalados}\n\nRESPONDA EM JSON:\n{\n  \"produtos\": [\n    {\n      \"nome_completo\": \"Nome exato lido\",\n      \"marca\": \"Marca\",\n      \"linha\": \"Linha/versÃ£o\",\n      \"sabor\": \"Sabor\",\n      \"peso\": \"170g\",\n      \"codigo_barras\": \"7891234567890 ou null\"\n    }\n  ]\n}\n\nAPENAS JSON.`;\n\nreturn {\n  json: {\n    ...item,\n    tem_embalagem: true,\n    pular_busca: false,\n    prompt_embalagem: prompt,\n    imageUrl: imageUrl,\n    produtos_embalados: produtosEmbalados\n  }\n};"
      },
      "id": "21cc4445-97c5-452c-bfcf-d114e252a3aa",
      "name": "7d. Detectar Embalagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13888,
        -1760
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"messages\": [\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": {{ JSON.stringify($json.prompt_embalagem) }}\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": {{ JSON.stringify($json.imageUrl) }}\n          }\n        }\n      ]\n    }\n  ],\n  \"max_tokens\": 500\n}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "a0a587d9-829c-47d6-8e8c-c0e8c315bc8f",
      "name": "7d. Vision - Ler Embalagem",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        14400,
        -1840
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================================================\n// 7e-3. APLICAR DADOS DA API - VERSÃƒO FINAL COMPLETA\n// =============================================================================\n// INSTRUÃ‡Ã•ES: Copie TODO este arquivo e cole no nÃ³ \"7e-3. Aplicar Dados API\"\n// NÃƒO delete nenhuma linha! O arquivo estÃ¡ completo e funcional.\n// =============================================================================\n\nconst item = $input.first().json;\nconst apiResponse = item;\nconst produtos = apiResponse.products || [];\n\n// âœ… CORREÃ‡ÃƒO: Buscar dados originais do inÃ­cio do fluxo\nlet dadosOriginais = {};\nlet produtosLidos = [];\n\ntry {\n  // Tentar buscar do nÃ³ 7d (tem os dados originais do 7a. PARSE-PASSIO)\n  dadosOriginais = $('7d. Detectar Embalagem').first().json;\n  console.log('âœ… Dados originais recuperados do 7d');\n} catch (e) {\n  console.log('âš ï¸ NÃ£o encontrou 7d, usando input');\n  dadosOriginais = item;\n}\n\ntry {\n  // Buscar produtos lidos do Vision\n  const dadosVision = $('7e-1. Preparar Busca API').first().json;\n  produtosLidos = dadosVision.produtos_lidos || [];\n  console.log('âœ… Produtos lidos recuperados:', produtosLidos.length);\n} catch (e) {\n  console.log('âš ï¸ NÃ£o encontrou produtos lidos');\n  produtosLidos = item.produtos_lidos || [];\n}\n\nlet alimentos = dadosOriginais.analise_foto?.alimentos || [];\nconsole.log('ðŸ½ï¸ Alimentos originais:', alimentos.length);\n\nconsole.log('=== APLICANDO DADOS DA API ===');\nconsole.log('Produtos encontrados na API:', produtos.length);\n\n// =============================================================================\n// BANCO LOCAL com dados CORRETOS de produtos brasileiros\n// =============================================================================\nconst bancoLocal = {\n  'activia triplo zero ameixa': { \n    nome: 'Activia Triplo Zero Ameixa', \n    peso: 170, \n    macros: { proteinas: 5.9, carboidratos: 7.5, gorduras: 0, calorias: 54 },\n    observacoes: 'Zero lactose, zero aÃ§Ãºcar, zero gordura'\n  },\n  'activia triplo zero morango': { \n    nome: 'Activia Triplo Zero Morango', \n    peso: 170, \n    macros: { proteinas: 5.9, carboidratos: 7.5, gorduras: 0, calorias: 54 },\n    observacoes: 'Zero lactose, zero aÃ§Ãºcar, zero gordura'\n  },\n  'activia triplo zero natural': { \n    nome: 'Activia Triplo Zero Natural', \n    peso: 170, \n    macros: { proteinas: 6.8, carboidratos: 5.1, gorduras: 0, calorias: 48 },\n    observacoes: 'Zero lactose, zero aÃ§Ãºcar, zero gordura'\n  },\n  'activia natural': {\n    nome: 'Activia Natural',\n    peso: 170,\n    macros: { proteinas: 6, carboidratos: 10.2, gorduras: 2, calorias: 82 }\n  },\n  'activia morango': {\n    nome: 'Activia Morango',\n    peso: 170,\n    macros: { proteinas: 5.3, carboidratos: 13.6, gorduras: 1.7, calorias: 90 }\n  },\n  'yakult': { \n    nome: 'Yakult', \n    peso: 80, \n    macros: { proteinas: 1.1, carboidratos: 11.5, gorduras: 0, calorias: 51 }\n  },\n  'danone grego natural': { \n    nome: 'Danone Grego Natural', \n    peso: 100, \n    macros: { proteinas: 5.5, carboidratos: 5.8, gorduras: 6.5, calorias: 103 }\n  },\n  'danone grego': { \n    nome: 'Danone Grego', \n    peso: 100, \n    macros: { proteinas: 5.5, carboidratos: 5.8, gorduras: 6.5, calorias: 103 }\n  }\n};\n\n// =============================================================================\n// âœ… PRIORIDADE 1: BANCO LOCAL (dados mais confiÃ¡veis que a API)\n// =============================================================================\nlet usouBancoLocal = false;\n\nconsole.log('ðŸ” Iniciando busca no banco local...');\nconsole.log('ðŸ“‹ Produtos lidos pelo Vision:', JSON.stringify(produtosLidos, null, 2));\n\nprodutosLidos.forEach(pl => {\n  const termoBusca = `${pl.marca || ''} ${pl.linha || ''} ${pl.sabor || ''}`.toLowerCase().trim();\n  console.log('ðŸ” Buscando no banco local:', termoBusca);\n  \n  // Buscar no banco local com match flexÃ­vel\n  const produtoLocal = Object.entries(bancoLocal).find(([chave]) => {\n    const palavrasChave = chave.split(' ');\n    const palavrasTermo = termoBusca.split(' ');\n    \n    // Conta quantas palavras coincidem\n    const coincidencias = palavrasChave.filter(p => \n      palavrasTermo.some(t => t.includes(p) || p.includes(t))\n    );\n    \n    // Se pelo menos 2 palavras coincidirem, considera match\n    return coincidencias.length >= 2;\n  });\n  \n  if (produtoLocal) {\n    const [chave, dados] = produtoLocal;\n    console.log('âœ… ENCONTRADO NO BANCO LOCAL:', chave);\n    console.log('ðŸ“Š Dados do banco:', JSON.stringify(dados, null, 2));\n    \n    // Atualizar os alimentos com dados do banco local\n    alimentos = alimentos.map(al => {\n      const nomeAl = ((al.nome || '') + (al.nome_original || '')).toLowerCase();\n      const ehRelacionado = ['yogurt', 'iogurte', 'activia', 'danone', 'yakult'].some(p => \n        nomeAl.includes(p)\n      );\n      \n      if (ehRelacionado) {\n        console.log(`ðŸ”„ Atualizando \"${al.nome}\" com dados do banco local`);\n        return {\n          ...al,\n          nome: dados.nome,\n          peso_gramas: dados.peso,\n          macros: dados.macros,\n          confianca: 'alta',\n          fonte: 'banco_local',\n          observacoes: dados.observacoes || ''\n        };\n      }\n      return al;\n    });\n    \n    usouBancoLocal = true;\n  } else {\n    console.log('âŒ NÃ£o encontrado no banco local para:', termoBusca);\n  }\n});\n\n// Se usou banco local, pular a API\nif (usouBancoLocal) {\n  console.log('âœ… USANDO BANCO LOCAL. Pulando API Open Food Facts.');\n}\n\n// =============================================================================\n// âœ… PRIORIDADE 2: API Open Food Facts (apenas se banco local nÃ£o encontrou)\n// =============================================================================\nelse if (produtos.length > 0) {\n  const produtoAPI = produtos[0]; // Pegar o primeiro resultado\n  const nutriments = produtoAPI.nutriments || {};\n  \n  console.log('ðŸ“¡ Produto encontrado na API:', produtoAPI.product_name);\n  console.log('ðŸ“¦ Nutriments raw:', JSON.stringify(nutriments, null, 2));\n  \n  // Extrair macros SEMPRE por 100g (padronizado)\n  const macrosPor100g = {\n    proteinas: parseFloat(nutriments.proteins_100g || nutriments.proteins || 0),\n    carboidratos: parseFloat(nutriments.carbohydrates_100g || nutriments.carbohydrates || 0),\n    gorduras: parseFloat(nutriments.fat_100g || nutriments.fat || 0),\n    calorias: parseFloat(nutriments['energy-kcal_100g'] || nutriments['energy-kcal'] || 0)\n  };\n  \n  console.log('ðŸ“Š Macros por 100g (da API):', macrosPor100g);\n  \n  // Extrair peso do produto (em gramas)\n  let pesoReal = 100; // padrÃ£o\n  \n  if (produtoAPI.quantity) {\n    // Tentar extrair nÃºmero do quantity (ex: \"170g\" â†’ 170)\n    const match = String(produtoAPI.quantity).match(/(\\d+(\\.\\d+)?)/);\n    if (match) {\n      pesoReal = parseFloat(match[1]);\n    }\n  } else if (produtoAPI.serving_size) {\n    const match = String(produtoAPI.serving_size).match(/(\\d+(\\.\\d+)?)/);\n    if (match) {\n      pesoReal = parseFloat(match[1]);\n    }\n  }\n  \n  console.log(`âš–ï¸ Peso real do produto: ${pesoReal}g`);\n  \n  // âœ… CÃLCULO CORRETO: (valor_por_100g * peso_real) / 100\n  const macrosReais = {\n    proteinas: Math.round((macrosPor100g.proteinas * pesoReal / 100) * 10) / 10,\n    carboidratos: Math.round((macrosPor100g.carboidratos * pesoReal / 100) * 10) / 10,\n    gorduras: Math.round((macrosPor100g.gorduras * pesoReal / 100) * 10) / 10,\n    calorias: Math.round(macrosPor100g.calorias * pesoReal / 100)\n  };\n  \n  console.log(`ðŸ“Š Macros calculados para ${pesoReal}g:`, macrosReais);\n  \n  // Atualizar alimentos (apenas os embalados)\n  alimentos = alimentos.map(al => {\n    const nomeAl = ((al.nome || '') + (al.nome_original || '')).toLowerCase();\n    const ehEmbalado = ['yogurt', 'iogurte', 'activia', 'danone', 'yakult', 'leite', 'milk'].some(p => \n      nomeAl.includes(p)\n    );\n    \n    if (ehEmbalado) {\n      console.log(`ðŸ”„ Atualizando \"${al.nome}\" com dados da API`);\n      return {\n        ...al,\n        nome: produtoAPI.product_name || produtoAPI.product_name_pt || al.nome,\n        peso_gramas: pesoReal,\n        macros: macrosReais,\n        confianca: 'alta',\n        fonte: 'open_food_facts',\n        codigo_barras: produtoAPI.code || null,\n        imagem: produtoAPI.image_url || null\n      };\n    }\n    return al;\n  });\n} \n\n// =============================================================================\n// âœ… PRIORIDADE 3: Manter dados originais do Passio (se nÃ£o encontrou em lugar nenhum)\n// =============================================================================\nelse {\n  console.log('âš ï¸ Produto nÃ£o encontrado na API nem no banco local.');\n  console.log('â„¹ï¸ Mantendo dados originais do Passio.');\n}\n\n// =============================================================================\n// RECALCULAR MACROS TOTAIS\n// =============================================================================\nconst macros_totais = alimentos.reduce((t, al) => ({\n  proteinas: Math.round((t.proteinas + (al.macros?.proteinas || 0)) * 10) / 10,\n  carboidratos: Math.round((t.carboidratos + (al.macros?.carboidratos || 0)) * 10) / 10,\n  gorduras: Math.round((t.gorduras + (al.macros?.gorduras || 0)) * 10) / 10,\n  calorias: Math.round(t.calorias + (al.macros?.calorias || 0))\n}), { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n\nconsole.log('ðŸ“Š Macros totais finais:', macros_totais);\nconsole.log('ðŸ½ï¸ Alimentos finais:', JSON.stringify(alimentos, null, 2));\n\n// =============================================================================\n// RETORNAR RESULTADO\n// =============================================================================\nreturn {\n  json: {\n    ...dadosOriginais,\n    analise_foto: {\n      alimentos: alimentos,\n      macros_totais: macros_totais,\n      observacoes: usouBancoLocal \n        ? `âœ… Dados nutricionais do banco local (produtos brasileiros)` \n        : produtos.length > 0 \n          ? `âœ… Dados nutricionais obtidos do Open Food Facts`\n          : `âœ… Dados nutricionais do Passio`\n    },\n    fonte_dados: usouBancoLocal ? 'banco_local' : produtos.length > 0 ? 'open_food_facts' : 'passio'\n  }\n};\n"
      },
      "id": "d2d11108-766f-42f5-9540-e99dca31718b",
      "name": "7e-3. Aplicar Dados API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15072,
        -1840
      ]
    },
    {
      "parameters": {
        "url": "=https://world.openfoodfacts.org/cgi/search.pl?search_terms={{ encodeURIComponent($json.termo_busca) }}&search_simple=1&action=process&json=1&page_size=3&countries_tags_en=brazil",
        "options": {
          "timeout": 30000
        }
      },
      "id": "0a67934f-841a-4a8b-bb20-ff483594730b",
      "name": "7e-2. Buscar Open Food Facts",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        14848,
        -1840
      ],
      "onError": "continueRegularOutput",
      "notes": "API gratuita com produtos brasileiros!\n\nExemplo: activia triplo zero â†’ retorna dados nutricionais reais"
    },
    {
      "parameters": {
        "jsCode": "// 7e-1. PREPARAR BUSCA NA API\nconst item = $input.first().json;\nconst visionResponse = item.choices?.[0]?.message?.content || '';\n\nconsole.log('=== PREPARANDO BUSCA API ===');\n\n// âœ… Buscar dados originais do 7d\nlet dadosOriginais = {};\ntry {\n  dadosOriginais = $('7d. Detectar Embalagem').first().json;\n  console.log('âœ… Dados originais recuperados (alimentos:', dadosOriginais.analise_foto?.alimentos?.length || 0, ')');\n} catch (e) {\n  console.log('âš ï¸ Erro ao buscar dados originais:', e.message);\n  dadosOriginais = item;\n}\n\n// Parse resposta Vision\nlet produtosLidos = [];\nif (visionResponse) {\n  try {\n    let json = visionResponse;\n    if (json.includes('```json')) json = json.split('```json')[1].split('```')[0];\n    else if (json.includes('```')) json = json.split('```')[1].split('```')[0];\n    const parsed = JSON.parse(json.trim());\n    produtosLidos = parsed.produtos || [];\n    console.log('âœ… Produtos lidos:', JSON.stringify(produtosLidos, null, 2));\n  } catch (e) {\n    console.error('âŒ Erro parse Vision:', e.message);\n  }\n}\n\n// Construir termos de busca\nconst buscas = produtosLidos.map(p => {\n  // Se tem cÃ³digo de barras, usar ele\n  if (p.codigo_barras && p.codigo_barras !== 'null') {\n    return {\n      tipo: 'barcode',\n      termo: p.codigo_barras,\n      produto: p\n    };\n  }\n  // SenÃ£o, buscar por nome\n  const termo = `${p.marca || ''} ${p.linha || ''} ${p.sabor || ''}`.trim();\n  return {\n    tipo: 'search',\n    termo: termo,\n    produto: p\n  };\n});\n\nreturn {\n  json: {\n    ...dadosOriginais,\n    visionResponse: item,\n    produtos_lidos: produtosLidos,\n    buscas: buscas,\n    termo_busca: buscas[0]?.termo || 'activia'\n  }\n};"
      },
      "id": "1b12320a-2ed0-4283-b92c-28545785326b",
      "name": "7e-1. Preparar Busca API",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14624,
        -1840
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.pular_busca }}",
              "value2": true
            }
          ]
        }
      },
      "id": "f131a33d-d254-4b05-abbc-11c41d94402c",
      "name": "7d-IF. Pular?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        14176,
        -1760
      ]
    },
    {
      "parameters": {
        "url": "https://web-production-c9eaf.up.railway.app/api/learnings/global",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": " nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        13152,
        -1760
      ],
      "id": "0130d66c-1fcc-4202-a1eb-f6c38a4eb367",
      "name": "7a-2. Buscar CorreÃ§Ãµes Firebase",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-weight/feedback",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.feedbackData) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        14848,
        -768
      ],
      "id": "e52b4f0f-c72d-48da-8f16-e5bfc2821c90",
      "name": "HTTP Request",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-weight/all-corrections",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret\t",
              "value": "nutribuddy-secret-2024"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        12032,
        -1760
      ],
      "id": "7d7df47b-66b3-4489-832d-4b65ea85c5ca",
      "name": "5g. Buscar CorreÃ§Ãµes Aprendidas",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-weight/feedback",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret\t",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type\t",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.feedbackData) }}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        15520,
        -432
      ],
      "id": "9ff265d0-d4fe-4dfe-a2ef-817d7dc19af7",
      "name": "FASE2: 6a-2. Enviar Feedback Aprendizado",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// FASE2: 7. ATUALIZAR CONTEXTO (versÃ£o robusta)\nconst correcaoData = $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').first().json;\n\nconsole.log('=== ATUALIZANDO CONTEXTO ===');\nconsole.log('ConversationId:', correcaoData.conversationId);\n\n// Verificar se tem dados para atualizar\nif (!correcaoData.contextUpdate || !correcaoData.contextUpdate.data) {\n  console.log('âš ï¸ Sem dados de contexto para atualizar, pulando...');\n  return {\n    json: {\n      ...correcaoData,\n      contextUpdated: false,\n      reason: 'no_context_data'\n    }\n  };\n}\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'PATCH',\n    url: `https://web-production-c9eaf.up.railway.app/api/n8n/conversations/${correcaoData.conversationId}/context`,\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: {\n      updates: correcaoData.contextUpdate.data\n    }\n  });\n  \n  console.log('âœ… Contexto atualizado:', response);\n  \n  return {\n    json: {\n      ...correcaoData,\n      contextUpdated: true,\n      updateResponse: response\n    }\n  };\n} catch (error) {\n  console.log('âŒ Erro ao atualizar contexto:', error.message);\n  \n  return {\n    json: {\n      ...correcaoData,\n      contextUpdated: false,\n      error: error.message\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15808,
        -720
      ],
      "id": "e33e6b25-9a2b-4490-8202-fb7edb71c3ca",
      "name": "FASE2: 7. Atualizar Contexto1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-calibration/suggestions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  patientId: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.patientId,\n  foodName: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalFood || 'Alimento',\n  foodType: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.feedbackData?.foodType || 'outros',\n  aiEstimate: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalWeight || 100,\n  userCorrection: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.newWeight || 100,\n  conversationId: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.conversationId\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        15808,
        -96
      ],
      "id": "d41cc450-6ee8-41cb-a35f-d22476403766",
      "name": "FASE2: 6a-3. Enviar para SugestÃµes",
      "onError": "continueRegularOutput",
      "notes": "Envia a correÃ§Ã£o de peso para a aba de SugestÃµes no Calibration Studio.\nO nutricionista pode aprovar ou rejeitar antes de entrar no aprendizado oficial.\n\nURL: /api/n8n/food-calibration/suggestions\nBody: { patientId, foodName, foodType, aiEstimate, userCorrection, conversationId }"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasSuggestions }}",
              "value2": true
            }
          ]
        }
      },
      "id": "ccce470f-3d13-4fc7-bb63-bc2520b693bc",
      "name": "Tem SugestÃµes?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        15072,
        -768
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.BACKEND_URL || 'https://web-production-c9eaf.up.railway.app' }}/api/n8n/food-calibration/suggestions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "={{ $env.N8N_WEBHOOK_SECRET || 'nutribuddy-secret-2024' }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"patientId\": \"{{ $json.patientId }}\",\n  \"foodName\": \"{{ $json.suggestionsToSave[0].foodName }}\",\n  \"foodType\": \"{{ $json.suggestionsToSave[0].foodType }}\",\n  \"aiEstimate\": {{ $json.suggestionsToSave[0].aiEstimate || 100 }},\n  \"userCorrection\": {{ $json.suggestionsToSave[0].userCorrection || 100 }},\n  \"conversationId\": \"{{ $json.conversationId }}\"\n}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "1ec1cdbf-ea78-48b8-b374-324b15e5e5a4",
      "name": "Salvar SugestÃ£o no Studio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        15296,
        -848
      ],
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Envia correÃ§Ã£o do paciente para a aba SugestÃµes do Calibration Studio.\n\nO nutricionista pode aprovar ou rejeitar."
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 6a-0. PREPARAR PROMPT VISION (ULTRA OTIMIZADO)\n// =====================================================\n// Prompt profissional para anÃ¡lise de refeiÃ§Ãµes brasileiras\n// Inclui: densidade, perspectiva, recipientes, macros precisos\n// =====================================================\n\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\nconst dietData = dietResponse.data || {};\nconst now = new Date();\nconst currentHour = now.getHours();\n\n// --- NOVO: BUSCAR CONFUSÃ•ES APRENDIDAS ---\nlet learnedHints = '';\ntry {\n  const confusionsResponse = await this.helpers.httpRequest({\n    method: 'GET',\n    url: 'https://web-production-c9eaf.up.railway.app/api/n8n/food-type-confusions/active',\n    headers: { 'X-Webhook-Secret': 'nutribuddy-secret-2024' }\n  });\n  \n  if (confusionsResponse && confusionsResponse.confusions && confusionsResponse.confusions.length > 0) {\n     learnedHints = `\\n\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\nðŸ§  APRENDIZADO RECENTE (ATENÃ‡ÃƒO!)\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n` + \n     confusionsResponse.promptText +\n     `\\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\\n`;\n  }\n} catch (e) {\n  console.log('âš ï¸ Erro ao buscar aprendizados de confusÃ£o');\n}\n\n// Identificar refeiÃ§Ã£o pelo horÃ¡rio\nlet mealType = 'RefeiÃ§Ã£o';\nlet prescribedMeal = null;\n\nif (dietData.meals && Array.isArray(dietData.meals)) {\n  if (currentHour >= 5 && currentHour < 9) {\n    mealType = 'CafÃ© da ManhÃ£';\n    prescribedMeal = dietData.meals.find(m => m.name && (m.name.toLowerCase().includes('cafÃ©') || m.name.toLowerCase().includes('desjejum')));\n  } else if (currentHour >= 9 && currentHour < 11) {\n    mealType = 'Lanche da ManhÃ£';\n    prescribedMeal = dietData.meals.find(m => m.name && m.name.toLowerCase().includes('colaÃ§Ã£o'));\n  } else if (currentHour >= 11 && currentHour < 15) {\n    mealType = 'AlmoÃ§o';\n    prescribedMeal = dietData.meals.find(m => m.name && m.name.toLowerCase().includes('almoÃ§o'));\n  } else if (currentHour >= 15 && currentHour < 19) {\n    mealType = 'Lanche da Tarde';\n    prescribedMeal = dietData.meals.find(m => m.name && m.name.toLowerCase().includes('lanche'));\n  } else {\n    mealType = 'Jantar';\n    prescribedMeal = dietData.meals.find(m => m.name && (m.name.toLowerCase().includes('jantar') || m.name.toLowerCase().includes('ceia')));\n  }\n}\n\n// Ã‚ncora da dieta prescrita\nlet dietAnchor = '';\nif (prescribedMeal && prescribedMeal.foods && prescribedMeal.foods.length > 0) {\n  const foodsList = prescribedMeal.foods.map(f => {\n    const amount = f.amount || f.quantidade || '?';\n    const unit = f.unit || f.unidade || 'g';\n    const name = f.name || f.nome || 'Alimento';\n    return `  â€¢ ${amount}${unit} ${name}`;\n  }).join('\\n');\n  \n  dietAnchor = `\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘ ðŸŽ¯ DIETA PRESCRITA: ${mealType.toUpperCase()}\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n${foodsList}\n\nâš¡ Se o alimento parecer SIMILAR ao prescrito, use o peso da\n   prescriÃ§Ã£o como base (ajuste Â±20% conforme visual).\n`;\n}\n\n// =============================================================\n// PROMPT ULTRA OTIMIZADO\n// =============================================================\n\nconst promptVision = `VocÃª Ã© um NUTRICIONISTA BRASILEIRO especialista em anÃ¡lise visual de refeiÃ§Ãµes.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸŽ¯ MISSÃƒO: Identificar TODOS os alimentos e estimar pesos com precisÃ£o\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${learnedHints}\n\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ ðŸ“‹ FORMATO DE RESPOSTA (APENAS JSON VÃLIDO, SEM MARKDOWN)  â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\n{\n  \"alimentos\": [\n    {\n      \"nome\": \"Nome do alimento em portuguÃªs\",\n      \"peso_gramas\": 150,\n      \"confianca\": \"alta|media|baixa\",\n      \"macros\": {\n        \"proteinas\": 30.0,\n        \"carboidratos\": 0.0,\n        \"gorduras\": 5.0,\n        \"calorias\": 165\n      }\n    }\n  ],\n  \"macros_totais\": {\n    \"proteinas\": 30.0,\n    \"carboidratos\": 45.0,\n    \"gorduras\": 12.0,\n    \"calorias\": 408\n  },\n  \"observacoes\": \"DescriÃ§Ã£o breve da refeiÃ§Ã£o\"\n}\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ“ REGRAS DE PERSPECTIVA (CRÃTICO PARA PESO CORRETO)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- FOTO DE CIMA (90Â°): Alimento parece MENOR â†’ Adicione +20%\n- FOTO DIAGONAL (45Â°): ReferÃªncia mais confiÃ¡vel\n- FOTO DE FRENTE: DifÃ­cil ver profundidade â†’ Seja conservador\n- SOMBRA GRANDE: Indica altura â†’ Alimento mais volumoso\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ“¦ TAMANHOS DE RECIPIENTES BRASILEIROS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nPRATOS:\n- Prato de sobremesa (15-18cm): 150-250g de comida\n- Prato raso mÃ©dio (22-24cm): 300-450g de comida\n- Prato raso grande (26-28cm): 450-600g de comida\n- Prato fundo: 400-550g de comida\n\nMARMITAS:\n- Marmita P (retangular pequena): 300-400g\n- Marmita M (quadrada mÃ©dia): 450-550g\n- Marmita G (retangular grande): 600-800g\n- Marmita fitness (compartimentos): 400-500g total\n\nOUTROS:\n- Tigela de aÃ§aÃ­ P: 200-300g\n- Tigela de aÃ§aÃ­ M: 400-500g\n- Cumbuca de sopa: 300-400ml\n- Copo americano: 190ml\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš–ï¸ DENSIDADE DOS ALIMENTOS (IMPORTANTE!)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nALIMENTOS DENSOS (pesam MAIS do que parecem):\n- Arroz cozido compactado: 1.1-1.3 g/cmÂ³\n- FeijÃ£o/lentilha: 1.2-1.4 g/cmÂ³\n- PurÃª de batata: 1.1 g/cmÂ³\n- Carne moÃ­da: 1.0-1.1 g/cmÂ³\n\nALIMENTOS LEVES (pesam MENOS do que parecem):\n- Salada de folhas: 0.2-0.4 g/cmÂ³\n- Pipoca: 0.03-0.05 g/cmÂ³\n- Arroz solto/aerado: 0.6-0.8 g/cmÂ³\n- MacarrÃ£o cozido: 0.7-0.9 g/cmÂ³\n\nREFERÃŠNCIA PADRÃƒO:\n- Carne sÃ³lida: 1.0 g/cmÂ³\n- Ãgua: 1.0 g/cmÂ³\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ¥© TABELA NUTRICIONAL BRASILEIRA (por 100g)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nPROTEÃNAS:\n- Frango grelhado: 31g prot, 3g gord, 0g carb = 165 kcal\n- Carne bovina magra: 26g prot, 7g gord, 0g carb = 170 kcal\n- Carne bovina gorda: 20g prot, 15g gord, 0g carb = 220 kcal\n- Peixe branco: 20g prot, 2g gord, 0g carb = 100 kcal\n- SalmÃ£o: 20g prot, 12g gord, 0g carb = 190 kcal\n- Ovo inteiro: 13g prot, 11g gord, 1g carb = 155 kcal\n- Ovo (sÃ³ clara): 11g prot, 0g gord, 1g carb = 50 kcal\n\nCARBOIDRATOS:\n- Arroz branco: 2.5g prot, 0.3g gord, 28g carb = 130 kcal\n- Arroz integral: 2.6g prot, 0.9g gord, 23g carb = 111 kcal\n- FeijÃ£o carioca: 5g prot, 0.5g gord, 14g carb = 77 kcal\n- FeijÃ£o preto: 4.5g prot, 0.5g gord, 14g carb = 77 kcal\n- Batata cozida: 2g prot, 0.1g gord, 17g carb = 77 kcal\n- Batata doce: 1.6g prot, 0.1g gord, 20g carb = 86 kcal\n- MacarrÃ£o cozido: 5g prot, 0.9g gord, 25g carb = 131 kcal\n- PÃ£o francÃªs: 8g prot, 3g gord, 49g carb = 260 kcal\n- Mandioca cozida: 1.4g prot, 0.3g gord, 30g carb = 125 kcal\n\nVEGETAIS:\n- Salada mista: 1.5g prot, 0.2g gord, 3g carb = 18 kcal\n- Tomate: 0.9g prot, 0.2g gord, 4g carb = 18 kcal\n- BrÃ³colis: 2.8g prot, 0.4g gord, 7g carb = 34 kcal\n- Legumes cozidos: 2g prot, 0.5g gord, 8g carb = 40 kcal\n\nGORDURAS:\n- Azeite (1 colher sopa): 0g prot, 14g gord, 0g carb = 120 kcal\n- Manteiga: 0.9g prot, 81g gord, 0g carb = 717 kcal\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ½ï¸ PRATOS BRASILEIROS TÃPICOS (IDENTIFICAR COMO UNIDADE)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nSALGADOS:\n- Coxinha mÃ©dia: 80-120g = 250-350 kcal\n- Coxinha grande: 150-200g = 450-600 kcal\n- Esfiha fechada: 60-80g = 150-200 kcal\n- Pastel mÃ©dio frito: 100-150g = 300-450 kcal\n- PÃ£o de queijo mÃ©dio: 25-35g = 80-120 kcal\n- Empada: 40-60g = 120-180 kcal\n- Quibe frito: 50-80g = 130-220 kcal\n\nPRATOS PRONTOS:\n- Torta de frango (fatia): 120-180g = 350-500 kcal\n- EmpadÃ£o (fatia): 150-200g = 400-550 kcal\n- Lasanha (porÃ§Ã£o): 250-350g = 400-550 kcal\n- Strogonoff + arroz: 350-500g = 500-700 kcal\n- Feijoada completa: 400-600g = 600-900 kcal\n- PF tÃ­pico: 400-600g = 600-850 kcal\n\nLANCHES:\n- X-burger simples: 200-250g = 450-550 kcal\n- X-salada: 280-350g = 550-700 kcal\n- X-tudo: 400-500g = 800-1000 kcal\n- AÃ§aÃ­ P sem cobertura: 200g = 200 kcal\n- AÃ§aÃ­ M com granola: 400g = 500-600 kcal\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸ“ REFERÃŠNCIAS VISUAIS DE PORÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nMÃƒOS:\n- Palma da mÃ£o fechada = 100g de carne\n- Punho fechado = 1 xÃ­cara = 150-200g de arroz/massa\n- Polegar = 1 colher de sopa = 15g de Ã³leo/manteiga\n- Ponta do polegar = 1 colher de chÃ¡ = 5g\n\nOBJETOS:\n- Baralho de cartas = 90-100g de carne\n- Bola de tÃªnis = 1/2 xÃ­cara = 100g\n- Bola de golfe = 2 colheres de sopa = 30g\n- Mouse de computador = 100g de batata/carboidrato\n\nCOLHERES:\n- Colher de sopa cheia = 25-35g (varia pelo alimento)\n- Concha mÃ©dia = 80-120g\n- Concha grande = 150-200g\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâš ï¸ REGRAS ABSOLUTAS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. ðŸ”´ NUNCA liste ingredientes separados de um prato pronto:\n   âŒ \"Creme, farinha, frango\" â†’ âœ… \"Torta de frango\"\n   âŒ \"Creme de leite, carne\" â†’ âœ… \"Strogonoff\"\n\n2. ðŸ”´ SE VER ALGO AMARELADO/DOURADO COM RECHEIO:\n   - Formato de gota = Coxinha\n   - Redondo/oval = Empada ou Esfiha\n   - Retangular = Pastel\n   - Fatia triangular = Torta salgada\n\n3. ðŸ”´ ARREDONDAMENTO:\n   - Arredondar para mÃºltiplos de 10g (ex: 147g â†’ 150g)\n   - Em dÃºvida â†’ arredonde PARA CIMA\n   - ProteÃ­na â†’ seja GENEROSO (melhor errar pra mais)\n\n4. ðŸ”´ FOTOS ESCURAS OU BORRADAS:\n   - Reduza confianÃ§a para \"baixa\"\n   - Mantenha estimativas conservadoras\n\n5. ðŸ”´ RETORNE APENAS JSON VÃLIDO:\n   - Sem markdown (\\`\\`\\`)\n   - Sem explicaÃ§Ãµes extras\n   - NÃºmeros como nÃºmeros, nÃ£o strings\n${dietAnchor}\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nðŸŽ¯ ANALISE A FOTO AGORA!\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;\n\nreturn {\n  json: {\n    promptVision: promptVision,\n    mealType: mealType,\n    hasDiet: !!prescribedMeal,\n    currentHour: currentHour,\n    promptVersion: 'ULTRA_LEARNING'\n  }\n};"
      },
      "id": "1fd7b565-cc3f-4b62-8d71-9c74ad7589a1",
      "name": "6a-0. Preparar Prompt Vision1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10912,
        -1760
      ],
      "notes": "V2 - PROMPT OTIMIZADO PARA COMIDAS BRASILEIRAS\n\nInclui:\n- Lista de pratos brasileiros comuns\n- ReferÃªncias visuais de peso\n- Regras crÃ­ticas para nÃ£o confundir ingredientes\n- Ã‚ncora da dieta prescrita\n\nEvita erros como:\n- Torta de frango â†’ 'creme + Ã³leo'\n- Strogonoff â†’ 'creme de leite'"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// FASE2: 1. Criar Contexto Inicial (versÃ£o CODE)\n// =====================================================\n\nconst itemData = $('1. Validar e Processar').first().json;\nconst visionData = $('7a-3. Aplicar Aprendizado1').first().json || {};\nconst mealData = $('11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica').first().json || {};\n\nconst conversationId = itemData.conversationId;\nconst patientId = itemData.patientId;\nconst prescriberId = itemData.prescriberId;\n\nif (!conversationId || !patientId) {\n  console.log('âš ï¸ Sem conversationId ou patientId, pulando criaÃ§Ã£o de contexto');\n  return { json: { ...itemData, contextCreated: false } };\n}\n\nconst body = {\n  type: 'meal_logging',\n  patientId: patientId,\n  prescriberId: prescriberId,\n  data: {\n    draftId: mealData.draftId || null,\n    foods: (visionData.analise_foto || {}).alimentos || [],\n    macros: (visionData.analise_foto || {}).macros_totais || {}\n  }\n};\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: `https://web-production-c9eaf.up.railway.app/api/n8n/conversations/${conversationId}/context`,\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: body\n  });\n  \n  console.log('âœ… Contexto criado:', response);\n  return { json: { ...itemData, contextCreated: true, contextResponse: response } };\n  \n} catch (error) {\n  console.log('âŒ Erro ao criar contexto:', error.message);\n  return { json: { ...itemData, contextCreated: false, error: error.message } };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16896,
        -1760
      ],
      "id": "9683922e-385b-4397-8f5d-81d539d276f6",
      "name": "FASE2: 1. Criar Contexto Inicial1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-4o\",\n  \"max_tokens\": 1500,\n  \"messages\": [\n    {\n      \"role\": \"system\",\n      \"content\": \"VocÃª Ã© um nutricionista brasileiro especializado em anÃ¡lise de alimentos por imagem. Retorne APENAS JSON vÃ¡lido, sem markdown, sem explicaÃ§Ãµes.\"\n    },\n    {\n      \"role\": \"user\",\n      \"content\": [\n        {\n          \"type\": \"text\",\n          \"text\": {{ JSON.stringify($('6a-0. Preparar Prompt Vision1').first().json.promptVision || 'Analise esta foto de refeiÃ§Ã£o. Liste os alimentos, peso estimado em gramas e macros (proteÃ­nas, carboidratos, gorduras, calorias). Retorne JSON vÃ¡lido.') }}\n        },\n        {\n          \"type\": \"image_url\",\n          \"image_url\": {\n            \"url\": \"data:{{ $('6a-2. Converter para Base64').first().json.mimeType || 'image/jpeg' }};base64,{{ $('6a-2. Converter para Base64').first().json.imageBase64 }}\",\n            \"detail\": \"high\"\n          }\n        }\n      ]\n    }\n  ]\n}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "420deee6-7abe-4d22-9461-4158eb358297",
      "name": "6a. Analisar Foto (GPT-4 Vision)1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12704,
        -1760
      ],
      "notesInFlow": true,
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      },
      "onError": "continueRegularOutput",
      "notes": "Chama GPT-4o Vision para analisar foto de refeiÃ§Ã£o.\n\nEntradas:\n- 6a-0: Prompt preparado com dieta como Ã¢ncora\n- 6a-2: Imagem em Base64\n\nSaÃ­da: JSON com alimentos, pesos e macros"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 7a. PARSE GPT-4 VISION (Substitui PARSE-PASSIO)\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst gptResponse = currentItem;\n\nconsole.log('ðŸ“Š [Parse Vision] Processando resposta GPT-4o...');\n\n// Extrair resposta do GPT-4\nlet content = '';\ntry {\n  if (gptResponse.choices && gptResponse.choices[0]) {\n    content = gptResponse.choices[0].message?.content || '';\n  }\n} catch (e) {\n  console.error('âŒ [Parse Vision] Erro ao extrair resposta:', e.message);\n  content = '';\n}\n\nconsole.log('ðŸ“ [Parse Vision] ConteÃºdo raw:', content.substring(0, 200) + '...');\n\n// Limpar markdown se houver\nlet jsonString = content\n  .replace(/```json\\n?/gi, '')\n  .replace(/```\\n?/gi, '')\n  .trim();\n\n// Tentar parsear JSON\nlet parsed = {\n  alimentos: [],\n  macros_totais: { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 },\n  observacoes: 'NÃ£o foi possÃ­vel analisar a imagem'\n};\n\ntry {\n  parsed = JSON.parse(jsonString);\n  console.log('âœ… [Parse Vision] JSON parseado com sucesso');\n  console.log('ðŸ½ï¸ [Parse Vision] Alimentos encontrados:', parsed.alimentos?.length || 0);\n} catch (e) {\n  console.error('âŒ [Parse Vision] Erro ao parsear JSON:', e.message);\n  console.error('âŒ [Parse Vision] String recebida:', jsonString.substring(0, 500));\n  \n  // Tentar extrair JSON de dentro do texto\n  const jsonMatch = jsonString.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    try {\n      parsed = JSON.parse(jsonMatch[0]);\n      console.log('âœ… [Parse Vision] JSON extraÃ­do com regex');\n    } catch (e2) {\n      console.error('âŒ [Parse Vision] Regex tambÃ©m falhou');\n    }\n  }\n}\n\n// Garantir estrutura correta\nif (!parsed.alimentos) parsed.alimentos = [];\nif (!parsed.macros_totais) {\n  parsed.macros_totais = { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 };\n}\n\n// Recalcular macros totais se necessÃ¡rio\nif (parsed.alimentos.length > 0 && (!parsed.macros_totais.calorias || parsed.macros_totais.calorias === 0)) {\n  parsed.macros_totais = parsed.alimentos.reduce((acc, food) => {\n    const macros = food.macros || {};\n    return {\n      proteinas: acc.proteinas + (macros.proteinas || 0),\n      carboidratos: acc.carboidratos + (macros.carboidratos || 0),\n      gorduras: acc.gorduras + (macros.gorduras || 0),\n      calorias: acc.calorias + (macros.calorias || 0)\n    };\n  }, { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n}\n\n// Formatar para o resto do workflow\nconst formattedResponse = {\n  alimentos: parsed.alimentos.map(food => ({\n    nome: food.nome || food.name || 'Alimento',\n    peso_gramas: food.peso_gramas || food.weight || 100,\n    peso_minimo: food.peso_minimo || Math.round((food.peso_gramas || 100) * 0.8),\n    peso_maximo: food.peso_maximo || Math.round((food.peso_gramas || 100) * 1.2),\n    confianca: food.confianca || 'media',\n    macros: {\n      proteinas: food.macros?.proteinas || food.macros?.protein || 0,\n      carboidratos: food.macros?.carboidratos || food.macros?.carbs || 0,\n      gorduras: food.macros?.gorduras || food.macros?.fat || 0,\n      calorias: food.macros?.calorias || food.macros?.calories || 0\n    }\n  })),\n  macros_totais: {\n    proteinas: Math.round(parsed.macros_totais.proteinas || 0),\n    carboidratos: Math.round(parsed.macros_totais.carboidratos || 0),\n    gorduras: Math.round(parsed.macros_totais.gorduras || 0),\n    calorias: Math.round(parsed.macros_totais.calorias || 0)\n  },\n  observacoes: parsed.observacoes || '',\n  fonte: 'gpt-4-vision'\n};\n\nconsole.log('ðŸ“Š [Parse Vision] Resultado final:', {\n  alimentosCount: formattedResponse.alimentos.length,\n  totalCalorias: formattedResponse.macros_totais.calorias\n});\n\n// Pegar dados do item original\nconst originalItem = $('6a-2. Converter para Base64').first().json;\n\nreturn {\n  json: {\n    ...originalItem,\n    analise_foto: formattedResponse,\n    gpt_vision_raw: content\n  }\n};"
      },
      "id": "c7ed27af-93ac-4bdd-98cc-a39773ed0d7d",
      "name": "7a. PARSE-VISION1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12928,
        -1760
      ],
      "notes": "Parseia a resposta do GPT-4 Vision.\n\nExtrai JSON com alimentos, pesos e macros.\nFormata para o resto do workflow entender."
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 7a-3. APLICAR APRENDIZADO DO FIREBASE\n// =====================================================\n// Este nÃ³ aplica correÃ§Ãµes aprendidas aos pesos da Vision AI\n// Se nÃ£o houver correÃ§Ãµes, passa os dados sem modificar\n// =====================================================\n\nconst dadosVision = $('7a. PARSE-VISION1').first().json;\n\n// Buscar correÃ§Ãµes do Firebase (pode estar vazio)\nlet correcoesAprendidas = {};\ntry {\n  const firebaseResponse = $('7a-2. Buscar CorreÃ§Ãµes Firebase').first().json;\n  const learnings = firebaseResponse.learnings || firebaseResponse.data || [];\n  if (firebaseResponse && firebaseResponse.success && learnings.length > 0) {\n    learnings.forEach(l => {\n      correcoesAprendidas[l.foodType] = {\n        correctionFactor: l.avgCorrectionFactor,\n        confidence: l.confidence,\n        totalSamples: l.totalSamples\n      };\n    });\n    console.log('ðŸ§  CorreÃ§Ãµes carregadas:', Object.keys(correcoesAprendidas).length);\n  }\n} catch (e) {\n  console.log('âš ï¸ Firebase nÃ£o disponÃ­vel, continuando sem correÃ§Ãµes');\n}\n\n// Se nÃ£o tem anÃ¡lise de foto, passa direto\nif (!dadosVision.analise_foto || !dadosVision.analise_foto.alimentos) {\n  console.log('âš ï¸ Sem alimentos para processar');\n  return { json: dadosVision };\n}\n\n// FunÃ§Ã£o para normalizar nome do alimento\nfunction normalizar(nome) {\n  return (nome || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/[^a-z0-9 ]/g, '')\n    .trim()\n    .split(' ')[0]; // Pega primeira palavra\n}\n\n// Aplicar correÃ§Ãµes aos alimentos\nlet correcoesAplicadas = 0;\nconst alimentosCorrigidos = dadosVision.analise_foto.alimentos.map(alimento => {\n  const nomeNormalizado = normalizar(alimento.nome || alimento.nome_original);\n  const pesoOriginal = alimento.peso_gramas || 100;\n  \n  // Verificar se existe correÃ§Ã£o aprendida\n  const correcao = correcoesAprendidas[nomeNormalizado];\n  \n  if (correcao && correcao.confidence >= 0.4) {\n    // Aplicar fator de correÃ§Ã£o\n    const pesoCorrigido = Math.round(pesoOriginal * correcao.correctionFactor);\n    const fator = correcao.correctionFactor;\n    \n    console.log(`ðŸ§  ${alimento.nome}: ${pesoOriginal}g x ${fator.toFixed(2)} = ${pesoCorrigido}g`);\n    \n    // Ajustar macros proporcionalmente\n    const macrosAjustados = alimento.macros ? {\n      proteinas: Math.round((alimento.macros.proteinas || 0) * fator * 10) / 10,\n      carboidratos: Math.round((alimento.macros.carboidratos || 0) * fator * 10) / 10,\n      gorduras: Math.round((alimento.macros.gorduras || 0) * fator * 10) / 10,\n      calorias: Math.round((alimento.macros.calorias || 0) * fator)\n    } : alimento.macros;\n    \n    correcoesAplicadas++;\n    \n    return {\n      ...alimento,\n      peso_gramas: pesoCorrigido,\n      _peso_original_vision: pesoOriginal,\n      _correcao_aplicada: true,\n      _fator_correcao: fator,\n      _confianca_correcao: correcao.confidence,\n      macros: macrosAjustados\n    };\n  }\n  \n  // Sem correÃ§Ã£o, retorna original\n  return {\n    ...alimento,\n    _correcao_aplicada: false\n  };\n});\n\n// Recalcular totais se houve correÃ§Ãµes\nlet macrosTotais = dadosVision.analise_foto.macros_totais;\nif (correcoesAplicadas > 0) {\n  macrosTotais = alimentosCorrigidos.reduce((total, al) => ({\n    proteinas: Math.round((total.proteinas + (al.macros?.proteinas || 0)) * 10) / 10,\n    carboidratos: Math.round((total.carboidratos + (al.macros?.carboidratos || 0)) * 10) / 10,\n    gorduras: Math.round((total.gorduras + (al.macros?.gorduras || 0)) * 10) / 10,\n    calorias: Math.round(total.calorias + (al.macros?.calorias || 0))\n  }), { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n}\n\nconsole.log(`âœ… ${correcoesAplicadas} correÃ§Ã£o(Ãµes) aplicada(s)`);\n\n// Retornar dados atualizados\nreturn {\n  json: {\n    ...dadosVision,\n    analise_foto: {\n      ...dadosVision.analise_foto,\n      alimentos: alimentosCorrigidos,\n      macros_totais: macrosTotais,\n      _aprendizado_aplicado: correcoesAplicadas > 0,\n      _total_correcoes: correcoesAplicadas,\n      _correcoes_disponiveis: Object.keys(correcoesAprendidas).length\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13376,
        -1760
      ],
      "id": "71db328e-762d-4b27-b319-c4fc051ebf5a",
      "name": "7a-3. Aplicar Aprendizado1"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 11a-bis. REGISTRAR REFEIÃ‡ÃƒO AUTOMÃTICA (versÃ£o robusta)\n// =====================================================\n\nconst itemData = $('1. Validar e Processar').first().json;\nconst parseData = $('7a-3. Aplicar Aprendizado1').first().json;\n\nconst patientId = itemData.patientId;\nconst conversationId = itemData.conversationId;\nconst mediaUrl = itemData.mediaUrl || null;\n\nif (!patientId) {\n  console.log('âš ï¸ Sem patientId, pulando registro de refeiÃ§Ã£o...');\n  return { json: { ...itemData, mealRegistered: false, reason: 'no_patient_id' } };\n}\n\nconst analise = parseData.analise_foto || {};\nconst alimentos = analise.alimentos || [];\nconst macrosTotais = analise.macros_totais || {};\nconst observacoes = analise.observacoes || 'RefeiÃ§Ã£o analisada por IA';\n\nif (alimentos.length === 0) {\n  console.log('âš ï¸ Nenhum alimento identificado, pulando registro...');\n  return { json: { ...itemData, mealRegistered: false, reason: 'no_foods_detected' } };\n}\n\nconsole.log('=== REGISTRANDO REFEIÃ‡ÃƒO ===');\nconsole.log('PatientId:', patientId);\nconsole.log('Alimentos:', alimentos.length);\nconsole.log('Calorias totais:', macrosTotais.calorias || 0);\n\ntry {\n  const messageTimestamp = itemData.timestamp || new Date().toISOString();\n  const brazilTime = new Date().toLocaleString(\"en-US\", { timeZone: \"America/Sao_Paulo\" });\n  const nowBR = new Date(brazilTime);\n  const hour = nowBR.getHours();\n  const minutes = nowBR.getMinutes();\n  const mealTime = `${String(hour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;\n  \n  let mealType = 'snack';\n  if (hour >= 5 && hour < 11) mealType = 'breakfast';\n  else if (hour >= 11 && hour < 15) mealType = 'lunch';\n  else if (hour >= 18 && hour < 23) mealType = 'dinner';\n  \n  console.log('â° HorÃ¡rio:', mealTime, '- Tipo:', mealType);\n\n  const requestBody = {\n    patientId: patientId,\n    conversationId: conversationId,\n    foods: alimentos,\n    macros: {\n      calories: macrosTotais.calorias || 0,\n      protein: macrosTotais.proteinas || 0,\n      carbs: macrosTotais.carboidratos || 0,\n      fats: macrosTotais.gorduras || 0\n    },\n    imageUrl: mediaUrl,\n    description: observacoes,\n    timestamp: messageTimestamp,\n    mealTime: mealTime,\n    mealType: mealType\n  };\n\n  console.log('Body:', JSON.stringify(requestBody, null, 2));\n\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://web-production-c9eaf.up.railway.app/api/meals/log-auto',\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: requestBody\n  });\n\n  console.log('âœ… RefeiÃ§Ã£o registrada:', response);\n\n  return {\n    json: {\n      ...itemData,\n      analise_foto: analise,\n      mealRegistered: true,\n      mealLogId: response.logId || null,\n      mealLogData: response.data || null,\n      registrationResponse: response\n    }\n  };\n\n} catch (error) {\n  console.log('âŒ Erro ao registrar refeiÃ§Ã£o:', error.message);\n  return {\n    json: {\n      ...itemData,\n      analise_foto: analise,\n      mealRegistered: false,\n      error: error.message\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16320,
        -1760
      ],
      "id": "474bb870-86ea-4e41-b7b0-728f5f839029",
      "name": "11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// BUSCAR ALIMENTO NA FOOD DATABASE\n// =====================================================\n// Usa a API /api/foods/lookup para buscar macros\n// Fallback para estimativa se nÃ£o encontrar\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst novoNomeAlimento = currentItem.novoNomeAlimento || '';\nconst novoPeso = currentItem.novoPeso || 100;\n\n// Se nÃ£o tem nome de alimento, passar adiante\nif (!novoNomeAlimento) {\n  return {\n    json: {\n      ...currentItem,\n      foodDbResult: null,\n      useFoodDb: false\n    }\n  };\n}\n\nconsole.log(`ðŸ” Buscando: ${novoNomeAlimento} (${novoPeso}g)`);\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://web-production-c9eaf.up.railway.app/api/foods/lookup',\n    headers: {\n      'X-Webhook-Secret': 'nutribuddy-secret-2024',\n      'Content-Type': 'application/json'\n    },\n    body: {\n      name: novoNomeAlimento,\n      weight: novoPeso\n    }\n  });\n\n  if (response.success && response.found) {\n    console.log(`âœ… Encontrado: ${response.data.name} (confianÃ§a: ${response.confidence}%)`);\n    console.log(`ðŸ“Š Macros: P:${response.data.macrosCalculated.proteinas}g | C:${response.data.macrosCalculated.carboidratos}g | G:${response.data.macrosCalculated.gorduras}g | ${response.data.macrosCalculated.calorias}kcal`);\n    \n    return {\n      json: {\n        ...currentItem,\n        foodDbResult: response.data,\n        useFoodDb: true,\n        macrosFromDb: response.data.macrosCalculated,\n        confidence: response.confidence\n      }\n    };\n  } else {\n    console.log(`âš ï¸ Alimento nÃ£o encontrado na base: ${novoNomeAlimento}`);\n    return {\n      json: {\n        ...currentItem,\n        foodDbResult: null,\n        useFoodDb: false,\n        searchedName: novoNomeAlimento\n      }\n    };\n  }\n} catch (error) {\n  console.log(`âŒ Erro ao buscar na Food DB: ${error.message}`);\n  return {\n    json: {\n      ...currentItem,\n      foodDbResult: null,\n      useFoodDb: false,\n      error: error.message\n    }\n  };\n}"
      },
      "id": "32e9f0a5-d8a7-45ba-b0a7-f47de8375bd8",
      "name": "Buscar Food DB",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14848,
        -368
      ],
      "notes": "Busca alimento na Food Database do Firebase\nRecebe: novoNomeAlimento, novoPeso\nRetorna: macros do banco se encontrar"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 7a-4. VERIFICAR CONFIANÃ‡A E PERGUNTAR\n// =====================================================\n// Se a IA tem baixa confianÃ§a, pergunta ao paciente\n// antes de registrar\n// =====================================================\n\nconst dadosAnalise = $input.first().json;\nconst analise = dadosAnalise.analise_foto || {};\nconst alimentos = analise.alimentos || [];\n\nconsole.log('=== VERIFICANDO CONFIANÃ‡A ===');\n\n// Verificar se hÃ¡ alimentos com baixa confianÃ§a\nconst alimentosBaixaConfianca = alimentos.filter(a => \n  a.confianca === 'baixa' || \n  (a.confianca === 'media' && (a.peso_gramas < 50 || a.peso_gramas > 500))\n);\n\nconst temBaixaConfianca = alimentosBaixaConfianca.length > 0;\nconst percentualBaixaConfianca = alimentos.length > 0 \n  ? (alimentosBaixaConfianca.length / alimentos.length) * 100 \n  : 0;\n\nconsole.log(`Alimentos total: ${alimentos.length}`);\nconsole.log(`Baixa confianÃ§a: ${alimentosBaixaConfianca.length} (${percentualBaixaConfianca.toFixed(0)}%)`);\n\n// Se mais de 50% tem baixa confianÃ§a, deve perguntar\nconst devePerguntar = percentualBaixaConfianca >= 50;\n\nif (devePerguntar && alimentosBaixaConfianca.length > 0) {\n  console.log('âš ï¸ BAIXA CONFIANÃ‡A - Gerando pergunta');\n  \n  // Gerar pergunta especÃ­fica\n  const primeiro = alimentosBaixaConfianca[0];\n  \n  // SugestÃµes de alimentos similares\n  const sugestoes = {\n    'torta': ['pamonha', 'empadÃ£o', 'quiche'],\n    'pamonha': ['torta salgada', 'milho cozido', 'curau'],\n    'coxinha': ['esfiha', 'quibe', 'bolinho'],\n    'pastel': ['empada', 'folhado', 'risole'],\n    'arroz': ['couscous', 'farofa', 'purÃª'],\n    'frango': ['carne de porco', 'peixe', 'tofu'],\n    'carne': ['frango', 'peixe', 'carne de porco']\n  };\n  \n  const nomeAlimento = (primeiro.nome || '').toLowerCase();\n  let alternativas = [];\n  \n  for (const [key, alts] of Object.entries(sugestoes)) {\n    if (nomeAlimento.includes(key)) {\n      alternativas = alts;\n      break;\n    }\n  }\n  \n  let pergunta;\n  if (alternativas.length > 0) {\n    pergunta = `ðŸ¤” NÃ£o tenho certeza se identifiquei corretamente...\\n\\nIsso Ã© *${primeiro.nome}*?\\n\\nOu seria:\\nâ€¢ ${alternativas.join('\\nâ€¢ ')}?\\n\\nMe confirma que eu registro certinho! ðŸ˜Š`;\n  } else {\n    pergunta = `ðŸ¤” NÃ£o tenho certeza sobre \"${primeiro.nome}\" (${primeiro.peso_gramas}g).\\n\\nEstÃ¡ correto ou vocÃª pode me ajudar com o nome/peso? ðŸ˜Š`;\n  }\n  \n  return {\n    json: {\n      ...dadosAnalise,\n      _devePerguntar: true,\n      _perguntaConfianca: pergunta,\n      _alimentoDuvidoso: primeiro.nome,\n      _alternativasSugeridas: alternativas\n    }\n  };\n}\n\n// Se confianÃ§a OK, seguir normalmente\nconsole.log('âœ… ConfianÃ§a OK - Seguindo fluxo normal');\n\nreturn {\n  json: {\n    ...dadosAnalise,\n    _devePerguntar: false,\n    _confiancaGeral: 100 - percentualBaixaConfianca\n  }\n};"
      },
      "id": "7d9f0f4f-60d8-4682-9efa-2826ebbc5cb2",
      "name": "7a-4. Verificar ConfianÃ§a",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13600,
        -1760
      ],
      "notes": "IA PROATIVA\n\nVerifica se Vision tem baixa confianÃ§a:\n- Se >50% dos alimentos tÃªm baixa confianÃ§a\n- Gera pergunta especÃ­fica com alternativas\n- Ex: 'Isso Ã© torta ou pamonha?'"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 11c. VERIFICAR METAS E ALERTAR\n// =====================================================\n// Verifica se o paciente estÃ¡ prÃ³ximo ou passou das metas\n// Adiciona alerta proativo na resposta\n// =====================================================\n\nconst dadosAnalise = $input.first().json;\nconst dietResponse = $('5a. Buscar Dieta (FOTO)').first().json || {};\n\nconsole.log('=== VERIFICANDO METAS ===');\n\n// Extrair macros da refeiÃ§Ã£o atual\nconst macrosRefeicao = dadosAnalise.analise_foto?.macros_totais || {};\nconst caloriasRefeicao = macrosRefeicao.calorias || 0;\nconst proteinaRefeicao = macrosRefeicao.proteinas || 0;\n\n// Extrair metas diÃ¡rias\nconst dietData = dietResponse.data || {};\nconst metaDiaria = {\n  calorias: dietData.dailyCalories || dietData.macros?.calories || 2000,\n  proteinas: dietData.dailyProtein || dietData.macros?.protein || 150\n};\n\nconsole.log('Meta diÃ¡ria:', metaDiaria);\nconsole.log('RefeiÃ§Ã£o atual:', macrosRefeicao);\n\n// Buscar consumo anterior do dia (se disponÃ­vel)\nlet consumoAnteriorHoje = 0;\ntry {\n  // Idealmente buscaria do histÃ³rico do dia\n  // Por enquanto, estimar baseado no horÃ¡rio\n  const hora = new Date().getHours();\n  \n  if (hora >= 12 && hora < 15) {\n    // AlmoÃ§o - estimar cafÃ© + lanche = ~400kcal\n    consumoAnteriorHoje = 400;\n  } else if (hora >= 15 && hora < 19) {\n    // Lanche da tarde - estimar cafÃ© + almoÃ§o = ~1000kcal\n    consumoAnteriorHoje = 1000;\n  } else if (hora >= 19) {\n    // Jantar - estimar cafÃ© + almoÃ§o + lanche = ~1400kcal\n    consumoAnteriorHoje = 1400;\n  }\n} catch (e) {\n  console.log('âš ï¸ Erro ao estimar consumo anterior');\n}\n\n// Calcular total estimado do dia\nconst totalEstimadoHoje = consumoAnteriorHoje + caloriasRefeicao;\nconst percentualMeta = (totalEstimadoHoje / metaDiaria.calorias) * 100;\n\nconsole.log(`Total estimado: ${totalEstimadoHoje}kcal (${percentualMeta.toFixed(0)}% da meta)`);\n\n// Gerar alertas\nlet alerta = null;\n\nif (totalEstimadoHoje > metaDiaria.calorias) {\n  const excesso = totalEstimadoHoje - metaDiaria.calorias;\n  alerta = {\n    tipo: 'excesso',\n    icone: 'âš ï¸',\n    mensagem: `VocÃª passou ${Math.round(excesso)}kcal da meta hoje! Que tal uma caminhada apÃ³s o jantar? ðŸš¶â€â™‚ï¸`,\n    gravidade: 'alta'\n  };\n} else if (percentualMeta >= 90) {\n  const falta = metaDiaria.calorias - totalEstimadoHoje;\n  alerta = {\n    tipo: 'proximo',\n    icone: 'ðŸ’¡',\n    mensagem: `VocÃª estÃ¡ a ${Math.round(falta)}kcal da meta. VÃ¡ com calma nas prÃ³ximas! ðŸ˜Š`,\n    gravidade: 'media'\n  };\n} else if (proteinaRefeicao < 20 && (new Date().getHours() >= 11 && new Date().getHours() < 15)) {\n  // Pouca proteÃ­na no almoÃ§o\n  alerta = {\n    tipo: 'proteina_baixa',\n    icone: 'ðŸ’ª',\n    mensagem: `Essa refeiÃ§Ã£o tem pouca proteÃ­na (${Math.round(proteinaRefeicao)}g). Tente compensar no lanche ou jantar!`,\n    gravidade: 'baixa'\n  };\n}\n\n// MotivaÃ§Ã£o positiva\nlet motivacao = null;\n\nif (!alerta && percentualMeta < 80) {\n  motivacao = {\n    icone: 'ðŸ‘',\n    mensagem: `Ã“tima escolha! VocÃª estÃ¡ ${Math.round(percentualMeta)}% da meta. Continue assim!`\n  };\n}\n\nconsole.log('Alerta:', alerta?.tipo || 'nenhum');\nconsole.log('MotivaÃ§Ã£o:', motivacao ? 'sim' : 'nÃ£o');\n\nreturn {\n  json: {\n    ...dadosAnalise,\n    _metaVerificada: true,\n    _percentualMeta: Math.round(percentualMeta),\n    _alerta: alerta,\n    _motivacao: motivacao,\n    _totalEstimadoHoje: totalEstimadoHoje,\n    _metaDiaria: metaDiaria\n  }\n};"
      },
      "id": "6421be62-eef1-4812-95b0-8cca3a53e9e4",
      "name": "11c. Verificar Metas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16608,
        -1760
      ],
      "notes": "IA PROATIVA - METAS\n\nVerifica:\n- Se passou da meta de calorias\n- Se estÃ¡ prÃ³ximo (>90%)\n- Se proteÃ­na estÃ¡ baixa no almoÃ§o\n\nGera alertas e motivaÃ§Ãµes contextuais"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "VocÃª Ã© um assistente de anÃ¡lise de intenÃ§Ã£o para um app de nutriÃ§Ã£o.\n\nCONTEXTO DA ÃšLTIMA ANÃLISE:\n{{ $json.context?.data?.lastAnalysis || 'NÃ£o hÃ¡ anÃ¡lise anterior' }}\n\nÃšLTIMA REFEIÃ‡ÃƒO ANALISADA:\n{{ JSON.stringify($json.context?.data?.alimentos || $json.context?.data?.foods || []) }}\n\nMENSAGEM DO USUÃRIO:\n\"{{ $json.userMessage }}\"\n\nANALISE a mensagem e retorne APENAS um JSON vÃ¡lido no formato:\n{\n  \"intention\": \"correction\" | \"addition\" | \"confirmation\" | \"question\" | \"cancellation\",\n  \"confidence\": 0.0 a 1.0,\n  \"extractedData\": {\n    \"newWeight\": nÃºmero ou null,\n    \"newFoodType\": \"nome do alimento\" ou null,\n    \"originalFood\": \"qual alimento estÃ¡ sendo corrigido\" ou null\n  },\n  \"reasoning\": \"explicaÃ§Ã£o curta\"\n}\n\nEXEMPLOS:\n- \"Eu comi 270g de pamonha\" â†’ correction com newWeight=270, newFoodType=\"pamonha\"\n- \"Na verdade era 200g\" â†’ correction com newWeight=200\n- \"Isso aÃ­ Ã© coxinha\" â†’ correction com newFoodType=\"coxinha\"\n- \"TambÃ©m comi uma banana\" â†’ addition\n- \"OK, pode salvar\" â†’ confirmation\n- \"O que eu comi hoje?\" â†’ question\n\nRESPONDA APENAS O JSON, SEM MARKDOWN:",
              "role": "system"
            },
            {
              "content": "{{ $json.userMessage }}"
            }
          ]
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.1
        }
      },
      "id": "9ac8b791-537f-4e22-8290-0af51d84e55b",
      "name": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.2,
      "position": [
        13824,
        -960
      ],
      "credentials": {
        "openAiApi": {
          "id": "CEN5JtLoEMjnVqvD",
          "name": "OpenAI NutriBuddy"
        }
      },
      "notes": "V5 - COM IA\n\nUsa GPT para analisar a intenÃ§Ã£o do usuÃ¡rio.\nMuito mais inteligente que regex!\n\nEntende contexto e variaÃ§Ãµes naturais da linguagem."
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// PROCESSAR RESPOSTA DA IA DE INTENÃ‡ÃƒO\n// ============================================\n\nconst input = $input.first().json;\nconst aiResponse = input.message?.content || input.text || '';\n\nconsole.log('ðŸ¤– Resposta da IA:', aiResponse);\n\n// Buscar dados originais\nconst originalData = $('1. Validar e Processar').first().json;\nconst userMessage = (originalData.content || '').toLowerCase()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n\n// ============================================\n// PRÃ‰-DETECÃ‡ÃƒO: ForÃ§ar correÃ§Ã£o em padrÃµes claros\n// ============================================\nlet forcedCorrection = null;\n\n// PadrÃµes que sÃ£o SEMPRE correÃ§Ã£o\nconst correcaoPatterns = [\n    /^(na verdade|na real|no lugar|corrigindo|era[m]?|sao|sÃ£o)\\s+/i,\n    /\\\\d+\\\\s*(g|gr|gramas?)\\\\s+(de\\\\s+)?/i,\n    /isso (e|Ã©|eh|era)/i\n];\n\nconst eCorrecaoClara = correcaoPatterns.some(p => p.test(originalData.content || ''));\n\nif (eCorrecaoClara) {\n    console.log('ðŸŽ¯ PRÃ‰-DETECÃ‡ÃƒO: Mensagem Ã© claramente uma CORREÃ‡ÃƒO');\n    \n    // Extrair peso\n    const pesoMatch = userMessage.match(/(\\\\d+)\\\\s*(gr?a?m?a?s?|g)/i);\n    const peso = pesoMatch ? parseInt(pesoMatch[1]) : null;\n    \n    // Extrair alimento: Pega tudo o que sobrar depois de gatilhos como \"sao\", \"era\", \"de\", \"eh\", interrompendo peso\n    let alimento = null;\n    // Tenta encontrar o que vem depois dos delimitadores de nome\n    const alimentoMatch = userMessage.match(/(?:de|e|Ã©|eh|era|sao|eram|e o|era o|sao o)\\\\s+([a-z].*)$/i);\n    if (alimentoMatch) {\n        alimento = alimentoMatch[1].trim();\n    } else {\n        // Fallback: Se nÃ£o achou delimitador mas tem peso, tenta pegar o que vem antes ou depois do peso\n        const semPeso = userMessage.replace(/\\\\d+\\\\s*(gr?a?m?a?s?|g)/gi, '').replace(/na verdade|era|sao/gi, '').trim();\n        if (semPeso.length > 2) alimento = semPeso;\n    }\n    \n    forcedCorrection = {\n        intention: 'correction',\n        confidence: 0.99,\n        extractedData: {\n            newWeight: peso,\n            newFoodType: alimento,\n            originalFood: null\n        },\n        reasoning: 'PrÃ©-detecÃ§Ã£o robusta: padrÃ£o de correÃ§Ã£o identificado'\n    };\n}\n\n// ============================================\n// PROCESSAR RESPOSTA DA IA (se nÃ£o forÃ§ou)\n// ============================================\nlet parsed;\n\nif (forcedCorrection) {\n    parsed = forcedCorrection;\n    console.log('âœ… Usando PRÃ‰-DETECÃ‡ÃƒO forÃ§ada');\n} else {\n    try {\n        let cleanResponse = aiResponse.replace(/```json\\\\n?/g, '').replace(/```\\\\n?/g, '').trim();\n        parsed = JSON.parse(cleanResponse);\n    } catch (e) {\n        parsed = { intention: 'question', confidence: 0.3, extractedData: {}, reasoning: 'Erro no parse' };\n    }\n}\n\n// Buscar contexto de forma mais agressiva\nlet contextData = null;\ntry {\n    // Tenta primeiro o nÃ³ de busca ativa\n    contextData = $('FASE2: 2. Buscar Contexto Ativo').first().json;\n} catch (e) {\n    // Se falhar, tenta ver se o nÃ³ 1 trouxe algo\n    try { contextData = $('1. Validar e Processar').first().json.context; } catch (e2) {}\n}\n\nreturn {\n    json: {\n        conversationId: originalData.conversationId,\n        patientId: originalData.patientId,\n        context: contextData?.context || contextData || null,\n        intention: {\n            type: parsed.intention,\n            confidence: parsed.confidence,\n            userMessage: originalData.content,\n            detectionMethod: forcedCorrection ? 'pre_detection' : 'ai_analysis',\n            extractedWeight: parsed.extractedData?.newWeight || null,\n            extractedFood: parsed.extractedData?.newFoodType || null,\n            originalFood: parsed.extractedData?.originalFood || null,\n            reasoning: parsed.reasoning\n        }\n    }\n};"
      },
      "id": "17b96ccc-33b4-465c-b5d9-e39e5215606e",
      "name": "FASE2: 4b. Processar Resposta IA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14176,
        -960
      ],
      "notes": "Processa a resposta JSON da IA e formata para o prÃ³ximo nÃ³"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// FASE2: 6a. AÃ‡ÃƒO: CORREÃ‡ÃƒO (V5.2 - LIMPEZA ROBUSTA)\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst intention = currentItem.intention || {};\nconst context = currentItem.context || {};\nconst userMessage = intention.userMessage || '';\n\nconsole.log('=== PROCESSANDO CORREÃ‡ÃƒO V5.2 ===');\n\n// =====================================================\n// 1. OBTER E LIMPAR DADOS EXTRAÃDOS PELA IA\n// =====================================================\nconst novoPeso = intention.extractedWeight;\nlet novoAlimento = intention.extractedFood;\nconst alimentoOriginal = intention.originalFood;\n\n// FunÃ§Ã£o para limpar termos do nome do alimento\nfunction limparNomeAlimento(nome) {\n    if (!nome) return nome;\n    return nome\n        .replace(/^(na verdade|na real|no lugar|corrigindo|sao|sÃ£o|era|eram|e|Ã©|eh|foi|foram|o|a|os|as)\\\\s+/gi, '') \n        .replace(/^(\\\\d+)\\\\s*(g|gr|gramas?)\\\\s*(de|do|da)?\\\\s*/gi, '') \n        .replace(/\\\\s+(\\\\d+)(g|gr|gramas).*$/gi, '') \n        .replace(/^(de|do|da)\\\\s+/gi, '') \n        .trim();\n}\n\nnovoAlimento = limparNomeAlimento(novoAlimento);\n\n// Dados da Ãºltima anÃ¡lise\nconst alimentosOriginais = context.data?.alimentos || context.data?.foods || [];\n// Fallback de macros mais profundo: tenta todos os campos possÃ­veis\nconst totalMacrosContext = (context.data?.totalMacros?.calorias > 0 ? context.data.totalMacros : null) || \n                           (context.data?.macros_totais?.calorias > 0 ? context.data.macros_totais : null) || \n                           (context.data?.macros?.calorias > 0 ? context.data.macros : null) || {};\n\nlet pesoOriginal = 100;\nlet nomeAlimentoOriginal = alimentoOriginal || 'alimento';\nlet indiceAlimento = 0;\n\nif (alimentosOriginais.length > 0) {\n    if (alimentoOriginal) {\n        const idx = alimentosOriginais.findIndex(a => \n            (a.nome || a.name || '').toLowerCase().includes(alimentoOriginal.toLowerCase())\n        );\n        if (idx >= 0) indiceAlimento = idx;\n    }\n    \n    const alimentoAlvo = alimentosOriginais[indiceAlimento];\n    pesoOriginal = alimentoAlvo.peso_gramas || alimentoAlvo.weight || 100;\n    nomeAlimentoOriginal = alimentoAlvo.nome || alimentoAlvo.name || nomeAlimentoOriginal;\n} else if (totalMacrosContext.calorias) {\n    pesoOriginal = 100;\n}\n\nconst isTypeConfusion = !!(novoAlimento && novoAlimento.toLowerCase() !== nomeAlimentoOriginal.toLowerCase());\nlet typeConfusionData = null;\n\nif (isTypeConfusion) {\n    typeConfusionData = {\n        aiIdentified: nomeAlimentoOriginal,\n        actualFood: novoAlimento,\n        patientId: currentItem.patientId,\n        conversationId: currentItem.conversationId,\n        imageUrl: context.data?.imageUrl || context.imageUrl || null\n    };\n}\n\nlet nomeExibicao = novoAlimento || nomeAlimentoOriginal;\n\n// =====================================================\n// 2. CALCULAR NOVOS MACROS\n// =====================================================\nlet macrosTotais = { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 };\nlet alimentosAtualizados = [];\nconst ratio = novoPeso ? (novoPeso / pesoOriginal) : 1;\n\nif (alimentosOriginais.length > 0) {\n    alimentosAtualizados = alimentosOriginais.map((food, index) => {\n        if (index === indiceAlimento) {\n            return {\n                ...food,\n                nome: novoAlimento || food.nome || food.name,\n                peso_gramas: novoPeso || food.peso_gramas,\n                macros: {\n                    proteinas: Math.round((food.macros?.proteinas || 0) * ratio * 10) / 10,\n                    carboidratos: Math.round((food.macros?.carboidratos || 0) * ratio * 10) / 10,\n                    gorduras: Math.round((food.macros?.gorduras || 0) * ratio * 10) / 10,\n                    calorias: Math.round((food.macros?.calorias || 0) * ratio)\n                }\n            };\n        }\n        return food;\n    });\n    macrosTotais = alimentosAtualizados.reduce((acc, food) => ({\n        proteinas: acc.proteinas + (food.macros?.proteinas || 0),\n        carboidratos: acc.carboidratos + (food.macros?.carboidratos || 0),\n        gorduras: acc.gorduras + (food.macros?.gorduras || 0),\n        calorias: acc.calorias + (food.macros?.calorias || 0)\n    }), { proteinas: 0, carboidratos: 0, gorduras: 0, calorias: 0 });\n} else if (totalMacrosContext.calorias) {\n    macrosTotais = {\n        proteinas: Math.round((totalMacrosContext.proteinas || 0) * ratio * 10) / 10,\n        carboidratos: Math.round((totalMacrosContext.carboidratos || 0) * ratio * 10) / 10,\n        gorduras: Math.round((totalMacrosContext.gorduras || 0) * ratio * 10) / 10,\n        calorias: Math.round((totalMacrosContext.calorias || 0) * ratio)\n    };\n    alimentosAtualizados = [{ nome: nomeExibicao, peso_gramas: novoPeso || 100, macros: macrosTotais }];\n}\n\nlet resposta;\nif (novoPeso && novoAlimento) {\n    resposta = `Entendi! Atualizei para *${novoPeso}g de ${nomeExibicao}* ðŸ½ï¸\\\\n\\\\nðŸ“Š *Macros recalculados:*\\\\nâ€¢ ProteÃ­na: ${Math.round(macrosTotais.proteinas)}g\\\\nâ€¢ Carboidratos: ${Math.round(macrosTotais.carboidratos)}g\\\\nâ€¢ Gorduras: ${Math.round(macrosTotais.gorduras)}g\\\\nâ€¢ Calorias: ${Math.round(macrosTotais.calorias)}\\\\n\\\\nâœ… Salvei essa correÃ§Ã£o para melhorar minhas anÃ¡lises futuras! ðŸ§ `;\n} else if (novoPeso) {\n    resposta = `Entendi! Atualizei o *${nomeExibicao}* para *${novoPeso}g* ðŸ“\\\\n\\\\nðŸ“Š *Macros recalculados:*\\\\nâ€¢ ProteÃ­na: ${Math.round(macrosTotais.proteinas)}g\\\\nâ€¢ Carboidratos: ${Math.round(macrosTotais.carboidratos)}g\\\\nâ€¢ Gorduras: ${Math.round(macrosTotais.gorduras)}g\\\\nâ€¢ Calorias: ${Math.round(macrosTotais.calorias)}\\\\n\\\\nâœ… Guardei essa correÃ§Ã£o para aprender! ðŸ§ `;\n} else {\n    resposta = `Entendi! EntÃ£o era *${nomeExibicao}*! ðŸ½ï¸\\\\n\\\\nDeseja ajustar o peso tambÃ©m?`;\n}\n\nreturn {\n    json: {\n        conversationId: currentItem.conversationId,\n        patientId: currentItem.patientId,\n        action: 'correction',\n        correction: { originalFood: nomeAlimentoOriginal, newFood: novoAlimento, originalWeight: pesoOriginal, newWeight: novoPeso },\n        hasTypeConfusion: isTypeConfusion,\n        typeConfusionData: typeConfusionData,\n        feedbackData: { foodType: (novoAlimento || nomeAlimentoOriginal).toLowerCase().replace(/\\\\s+/g, '_'), estimatedWeight: pesoOriginal, correctedWeight: novoPeso || pesoOriginal, patientId: currentItem.patientId },\n        sendFeedback: !!novoPeso,\n        contextUpdate: {\n            data: {\n                alimentos: alimentosAtualizados,\n                foods: alimentosAtualizados,\n                totalMacros: macrosTotais,\n                macros_totais: macrosTotais,\n                lastCorrection: { weight: novoPeso, food: nomeExibicao, at: new Date().toISOString() }\n            }\n        },\n        responseMessage: resposta\n    }\n};"
      },
      "id": "6496f7bd-646b-4116-b3b0-60a618f8d54e",
      "name": "FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        15072,
        -368
      ],
      "notes": "V5 - COM DADOS DA IA\n\nRecebe dados jÃ¡ extraÃ­dos pela IA:\n- extractedWeight\n- extractedFood\n- originalFood\n\nResponde de forma inteligente e envia feedback para aprendizado."
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 3a-PRE. DETECTAR CORREÃ‡ÃƒO RÃPIDA (ANTES DO CONTEXTO)\n// =====================================================\n// Este nÃ³ detecta se a mensagem parece ser uma correÃ§Ã£o\n// ANTES de verificar se tem contexto\n// Assim, correÃ§Ãµes funcionam mesmo se o contexto expirou\n// =====================================================\n\nconst currentItem = $input.first().json;\nconst userMessage = (currentItem.content || '').toLowerCase();\nconst originalMessage = currentItem.content || '';\n\nconsole.log('ðŸ” [PRE-CHECK] Verificando se Ã© correÃ§Ã£o:', userMessage);\n\n// PADRÃ•ES DE CORREÃ‡ÃƒO (muito provÃ¡vel)\nconst padroesCor = [\n    /na verdade/i,\n    /eu comi.*\\d+\\s*(g|gr|gramas?)/i,\n    /eram?\\s*\\d+\\s*(g|gr|gramas?)/i,\n    /\\d+\\s*(g|gr|gramas?)\\s*(de\\s+)?\\w+/i,\n    /isso (Ã©|e|eh)\\s+/i,\n    /(nÃ£o|nao).*era/i,\n    /corrig/i,\n    /metade disso/i,\n    /o (certo|correto) (Ã©|e|era)/i\n];\n\nconst pareceCorrecao = padroesCor.some(p => p.test(userMessage));\n\n// Extrair dados bÃ¡sicos se parecer correÃ§Ã£o\nlet dadosExtraidos = null;\nif (pareceCorrecao) {\n    console.log('âœ… [PRE-CHECK] PARECE CORREÃ‡ÃƒO!');\n    \n    // Tentar extrair peso\n    const pesoMatch = userMessage.match(/(\\d+)\\s*(g|gr|gramas?)/i);\n    const peso = pesoMatch ? parseInt(pesoMatch[1]) : null;\n    \n    // Tentar extrair alimento (depois de 'de')\n    const alimentoMatch = userMessage.match(/(?:de\\s+|Ã©\\s+|eh\\s+)(\\w+)/i);\n    const alimento = alimentoMatch ? alimentoMatch[1] : null;\n    \n    dadosExtraidos = {\n        peso: peso,\n        alimento: alimento\n    };\n    \n    console.log('ðŸ“Š [PRE-CHECK] Peso:', peso, 'Alimento:', alimento);\n}\n\n// Retornar com flag\nreturn {\n    json: {\n        ...currentItem,\n        _pareceCorrecao: pareceCorrecao,\n        _dadosCorrecaoRapida: dadosExtraidos,\n        _bypassContext: pareceCorrecao  // Se parece correÃ§Ã£o, nÃ£o precisa ter contexto\n    }\n};"
      },
      "id": "709e2fe5-3f68-4966-b20e-3ce9b891c4db",
      "name": "3a-PRE. Detectar CorreÃ§Ã£o RÃ¡pida",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12928,
        -1344
      ],
      "notes": "PRE-CHECK antes de verificar contexto.\n\nDetecta se a mensagem PARECE uma correÃ§Ã£o:\n- 'Eu comi 270g de pamonha'\n- 'Na verdade eram 200g'\n- 'Isso Ã© coxinha'\n\nSe parece correÃ§Ã£o, seta _bypassContext = true\npara ir direto para anÃ¡lise de intenÃ§Ã£o."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f6b33719-9e76-44bb-be2e-159ce0296e55",
              "leftValue": "={{ $json._pareceCorrecao }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        13152,
        -1344
      ],
      "id": "5b72e790-91af-4486-ba38-317ae43341b4",
      "name": "3a-IF. Ã‰ CorreÃ§Ã£o?"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// 3a-MAP. PREPARAR DADOS PARA ANÃLISE DE INTENÃ‡ÃƒO\n// =====================================================\n// Mapeia os campos do input para o formato esperado\n// pelo nÃ³ FASE2: 4. Analisar IntenÃ§Ã£o (IA)\n// =====================================================\n\nconst item = $input.first().json;\n\nconsole.log('ðŸ”„ [MAP] Preparando dados para IA');\nconsole.log('ðŸ“ Mensagem:', item.content);\nconsole.log('ðŸ†” ConversationId:', item.conversationId);\n\nreturn {\n  json: {\n    // Dados bÃ¡sicos\n    conversationId: item.conversationId,\n    patientId: item.patientId,\n    prescriberId: item.prescriberId,\n    \n    // O campo que o OpenAI espera\n    userMessage: item.content,\n    \n    // Contexto (vazio quando vem direto, sem passar pelo contexto)\n    context: {\n      hasContext: false,\n      data: {\n        alimentos: [],\n        foods: []\n      }\n    },\n    \n    // Dados extras da prÃ©-detecÃ§Ã£o (Ãºteis para debug)\n    _pareceCorrecao: item._pareceCorrecao,\n    _dadosCorrecaoRapida: item._dadosCorrecaoRapida,\n    _bypassContext: item._bypassContext\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13600,
        -720
      ],
      "id": "f6562240-17ac-4cde-bc64-6c845c529abc",
      "name": "3a-MAP. Preparar para IA"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "https://web-production-c9eaf.up.railway.app/api/meals/correct-last",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  patientId: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.patientId,\n  foods: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.foods || [],\n  macros: {\n    calories: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.calorias || 0,\n    protein: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.proteinas || 0,\n    carbs: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.carboidratos || 0,\n    fats: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros?.gorduras || 0\n  },\n  correctionDetails: {\n    originalFood: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalFood || '',\n    newFood: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.newFood || '',\n    originalWeight: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.originalWeight || 0,\n    newWeight: $('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.correction?.newWeight || 0\n  },\n  correctedBy: 'patient'\n}) }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "ad6b39e2-7a86-4035-ab27-0037820dc93b",
      "name": "FASE2: 6a-4. Atualizar RefeiÃ§Ã£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        15296,
        -432
      ],
      "onError": "continueRegularOutput",
      "notes": "Atualiza a Ãºltima refeiÃ§Ã£o do paciente com os dados corrigidos.\n\nEndpoint: PATCH /api/meals/correct-last\n\nBody:\n- patientId\n- foods: array de alimentos corrigidos\n- macros: macros recalculados\n- correctionDetails: detalhes da correÃ§Ã£o\n\nO endpoint busca automaticamente a Ãºltima refeiÃ§Ã£o de hoje e atualiza."
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "https://web-production-c9eaf.up.railway.app/api/meals/correct-last",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"patientId\": \"{{ $('1. Validar e Processar').first().json.patientId }}\",\n  \"foods\": {{ JSON.stringify($('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.foods || []) }},\n  \"macros\": {{ JSON.stringify($('FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o').item.json.contextUpdate?.data?.totalMacros || {}) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        15808,
        112
      ],
      "id": "bf9904d0-90cc-44cc-a547-dbd86a5c92b5",
      "name": "FASE2: 6a-4. Atualizar Banco (Nova API)"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hasTypeConfusion }}",
              "value2": true
            }
          ]
        }
      },
      "id": "947c2230-a4bb-4987-827e-cafd10f702ed",
      "name": "Ã‰ ConfusÃ£o de Tipo?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        15488,
        -80
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://web-production-c9eaf.up.railway.app/api/n8n/food-type-confusions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Webhook-Secret",
              "value": "nutribuddy-secret-2024"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.typeConfusionData) }}",
        "options": {}
      },
      "id": "a60c1f44-ea2b-475b-acc4-597784ef01c6",
      "name": "FASE2: 6a-3.5 Enviar ConfusÃ£o de Tipo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        15792,
        -272
      ],
      "notes": "Envia a confusÃ£o de tipo para o backend para aprendizado futuro."
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook: Nova Mensagem": {
      "main": [
        [
          {
            "node": "1. Validar e Processar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1. Validar e Processar": {
      "main": [
        [
          {
            "node": "2. Foi Filtrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2. Foi Filtrado?": {
      "main": [
        [
          {
            "node": "Responder: Filtrado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3. TEM FOTO?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. Buscar Conversa": {
      "main": [
        [
          {
            "node": "3-bis. Checar Assinatura",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3-bis. Checar Assinatura": {
      "main": [
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder: Assinatura Suspensa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4. Buscar HistÃ³rico": {
      "main": [
        [
          {
            "node": "5. Buscar Dieta do Paciente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5. Buscar Dieta do Paciente": {
      "main": [
        [
          {
            "node": "5h. Detectar Pergunta sobre HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6. Construir Contexto IA": {
      "main": [
        [
          {
            "node": "7. AnÃ¡lise IA (OpenAI)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7. AnÃ¡lise IA (OpenAI)": {
      "main": [
        [
          {
            "node": "8. Parse AnÃ¡lise IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8. Parse AnÃ¡lise IA": {
      "main": [
        [
          {
            "node": "9. Deve Responder?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9. Deve Responder?": {
      "main": [
        [
          {
            "node": "10. Enviar Auto-resposta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "NÃ£o Responder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10. Enviar Auto-resposta": {
      "main": [
        [
          {
            "node": "12. Responder: Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3. TEM FOTO?": {
      "main": [
        [
          {
            "node": "4a. Buscar Conversa (FOTO)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3a-PRE. Detectar CorreÃ§Ã£o RÃ¡pida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4a. Buscar Conversa (FOTO)": {
      "main": [
        [
          {
            "node": "4-bis. Checar (FOTO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4-bis. Checar (FOTO)": {
      "main": [
        [
          {
            "node": "5a. Buscar Dieta (FOTO)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder: Assinatura Suspensa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5a. Buscar Dieta (FOTO)": {
      "main": [
        [
          {
            "node": "6a-0. Preparar Prompt Vision1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8a. Comparar com Dieta": {
      "main": [
        [
          {
            "node": "9a. Construir Contexto Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9a. Construir Contexto Resposta": {
      "main": [
        [
          {
            "node": "10a. IA Gera Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "10a. IA Gera Resposta": {
      "main": [
        [
          {
            "node": "11a. Parse Resposta Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11a. Parse Resposta Final": {
      "main": [
        [
          {
            "node": "11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "12a. Enviar Resposta (FOTO)": {
      "main": [
        [
          {
            "node": "12. Responder: Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5c. Tem Dieta Prescrita?": {
      "main": [
        [
          {
            "node": "5d. IF: Tem Dieta?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5d. IF: Tem Dieta?": {
      "main": [
        [
          {
            "node": "5e. Usar Dieta Prescrita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "5b. Buscar Macros Perfil (FALLBACK)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5b. Buscar Macros Perfil (FALLBACK)": {
      "main": [
        [
          {
            "node": "5f. Usar Macros do Perfil",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5e. Usar Dieta Prescrita": {
      "main": [
        [
          {
            "node": "5g. Buscar CorreÃ§Ãµes Aprendidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5f. Usar Macros do Perfil": {
      "main": [
        [
          {
            "node": "5g. Buscar CorreÃ§Ãµes Aprendidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a-1. Baixar Imagem": {
      "main": [
        [
          {
            "node": "6a-2. Converter para Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a-2. Converter para Base64": {
      "main": [
        [
          {
            "node": "6a. Analisar Foto (GPT-4 Vision)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 2. Buscar Contexto Ativo": {
      "main": [
        [
          {
            "node": "FASE2: 3. Tem Contexto Ativo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 3. Tem Contexto Ativo?": {
      "main": [
        [
          {
            "node": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6b. AÃ§Ã£o: AdiÃ§Ã£o": {
      "main": [
        [
          {
            "node": "FASE2: 7. Atualizar Contexto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 8. Registrar RefeiÃ§Ã£o": {
      "main": [
        [
          {
            "node": "FASE2: 9. Deletar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6d. AÃ§Ã£o: Cancelamento": {
      "main": [
        [
          {
            "node": "FASE2: 9. Deletar Contexto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 9. Deletar Contexto": {
      "main": [
        [
          {
            "node": "FASE2: 10. Enviar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 10. Enviar Resposta": {
      "main": [
        [
          {
            "node": "FASE2: 11. Responder Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2a. TEM ÃUDIO?": {
      "main": [
        [
          {
            "node": "AUDIO: 1. Baixar Arquivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3. Buscar Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AUDIO: 1. Baixar Arquivo": {
      "main": [
        [
          {
            "node": "AUDIO: 2. Preparar para Whisper",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AUDIO: 2. Preparar para Whisper": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AUDIO: 4. Parse TranscriÃ§Ã£o": {
      "main": [
        [
          {
            "node": "3. Buscar Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "AUDIO: 4. Parse TranscriÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11b. Dividir em 3 Mensagens": {
      "main": [
        [
          {
            "node": "12a. Enviar Resposta (FOTO)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5h. Detectar Pergunta sobre HistÃ³rico": {
      "main": [
        [
          {
            "node": "5h-IF. Ã‰ Pergunta sobre HistÃ³rico?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5h-IF. Ã‰ Pergunta sobre HistÃ³rico?": {
      "main": [
        [
          {
            "node": "5i. Extrair PerÃ­odo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "5z. Buscar Contexto Completo do Paciente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5i. Extrair PerÃ­odo": {
      "main": [
        [
          {
            "node": "5j. Buscar HistÃ³rico DiÃ¡rio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5j. Buscar HistÃ³rico DiÃ¡rio": {
      "main": [
        [
          {
            "node": "5k. Construir Contexto com HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5k. Construir Contexto com HistÃ³rico": {
      "main": [
        [
          {
            "node": "6. Construir Contexto IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a. Tem Contexto FASE2?": {
      "main": [
        [
          {
            "node": "3b. IF: Tem Dados?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3b. IF: Tem Dados?": {
      "main": [
        [
          {
            "node": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3. Buscar Conversa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Roteador de IntenÃ§Ã£o": {
      "main": [
        [
          {
            "node": "FASE2: 6b. AÃ§Ã£o: AdiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 6c. AÃ§Ã£o: ConfirmaÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar Food DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 6d. AÃ§Ã£o: Cancelamento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "4. Buscar HistÃ³rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5z. Buscar Contexto Completo do Paciente": {
      "main": [
        [
          {
            "node": "6. Construir Contexto IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7d. Detectar Embalagem": {
      "main": [
        [
          {
            "node": "7d-IF. Pular?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7d. Vision - Ler Embalagem": {
      "main": [
        [
          {
            "node": "7e-1. Preparar Busca API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7e-3. Aplicar Dados API": {
      "main": [
        [
          {
            "node": "8a. Comparar com Dieta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7e-2. Buscar Open Food Facts": {
      "main": [
        [
          {
            "node": "7e-3. Aplicar Dados API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7e-1. Preparar Busca API": {
      "main": [
        [
          {
            "node": "7e-2. Buscar Open Food Facts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7d-IF. Pular?": {
      "main": [
        [
          {
            "node": "8a. Comparar com Dieta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "7d. Vision - Ler Embalagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a-2. Buscar CorreÃ§Ãµes Firebase": {
      "main": [
        [
          {
            "node": "7a-3. Aplicar Aprendizado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Tem SugestÃµes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5g. Buscar CorreÃ§Ãµes Aprendidas": {
      "main": [
        [
          {
            "node": "6a-1. Baixar Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tem SugestÃµes?": {
      "main": [
        [
          {
            "node": "Salvar SugestÃ£o no Studio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 8. Registrar RefeiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar SugestÃ£o no Studio": {
      "main": [
        [
          {
            "node": "FASE2: 8. Registrar RefeiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a-0. Preparar Prompt Vision1": {
      "main": [
        [
          {
            "node": "5c. Tem Dieta Prescrita?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 1. Criar Contexto Inicial1": {
      "main": [
        [
          {
            "node": "11b. Dividir em 3 Mensagens",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6a. Analisar Foto (GPT-4 Vision)1": {
      "main": [
        [
          {
            "node": "7a. PARSE-VISION1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a. PARSE-VISION1": {
      "main": [
        [
          {
            "node": "7a-2. Buscar CorreÃ§Ãµes Firebase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a-3. Aplicar Aprendizado1": {
      "main": [
        [
          {
            "node": "7a-4. Verificar ConfianÃ§a",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11a-bis. Registrar RefeiÃ§Ã£o AutomÃ¡tica": {
      "main": [
        [
          {
            "node": "11c. Verificar Metas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Food DB": {
      "main": [
        [
          {
            "node": "FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7a-4. Verificar ConfianÃ§a": {
      "main": [
        [
          {
            "node": "7d. Detectar Embalagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "11c. Verificar Metas": {
      "main": [
        [
          {
            "node": "FASE2: 1. Criar Contexto Inicial1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 4. Analisar IntenÃ§Ã£o (IA)": {
      "main": [
        [
          {
            "node": "FASE2: 4b. Processar Resposta IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 4b. Processar Resposta IA": {
      "main": [
        [
          {
            "node": "Roteador de IntenÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a. AÃ§Ã£o: CorreÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Ã‰ ConfusÃ£o de Tipo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ã‰ ConfusÃ£o de Tipo?": {
      "main": [
        [
          {
            "node": "FASE2: 6a-3.5 Enviar ConfusÃ£o de Tipo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FASE2: 6a-3. Enviar para SugestÃµes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-3.5 Enviar ConfusÃ£o de Tipo": {
      "main": [
        [
          {
            "node": "FASE2: 6a-3. Enviar para SugestÃµes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-3. Enviar para SugestÃµes": {
      "main": [
        [
          {
            "node": "FASE2: 6a-4. Atualizar RefeiÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-4. Atualizar RefeiÃ§Ã£o": {
      "main": [
        [
          {
            "node": "FASE2: 6a-2. Enviar Feedback Aprendizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-2. Enviar Feedback Aprendizado": {
      "main": [
        [
          {
            "node": "FASE2: 7. Atualizar Contexto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 7. Atualizar Contexto1": {
      "main": [
        [
          {
            "node": "FASE2: 6a-4. Atualizar Banco (Nova API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FASE2: 6a-4. Atualizar Banco (Nova API)": {
      "main": [
        [
          {
            "node": "FASE2: 10. Enviar Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a-PRE. Detectar CorreÃ§Ã£o RÃ¡pida": {
      "main": [
        [
          {
            "node": "3a-IF. Ã‰ CorreÃ§Ã£o?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a-IF. Ã‰ CorreÃ§Ã£o?": {
      "main": [
        [
          {
            "node": "3a-MAP. Preparar para IA",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "3a. Tem Contexto FASE2?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3a-MAP. Preparar para IA": {
      "main": [
        [
          {
            "node": "FASE2: 4. Analisar IntenÃ§Ã£o (IA)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "1e339b5b-c150-473f-abad-b2ac95785048",
  "meta": {
    "instanceId": "2ecd07a43b0e041940f064474e8a18afb2a90a41122cda3ef71839a8bff4edf7"
  },
  "id": "3bxyZ4N6ILTd7ozY",
  "tags": []
}