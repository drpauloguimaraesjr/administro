{
    "name": "CALYX_Sophia_Medical_V1",
    "nodes": [
        {
            "parameters": {
                "path": "sophia-medical-webhook",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "webhook-trigger",
            "name": "WhatsApp Trigger",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                0,
                0
            ]
        },
        {
            "parameters": {
                "resource": "databasePage",
                "operation": "getAll",
                "databaseId": "2f342023207580049c5fe31e9b4c19be",
                "returnAll": true,
                "filterType": "manual",
                "matchType": "all",
                "filters": {
                    "conditions": [
                        {
                            "key": "Status",
                            "condition": "equals",
                            "statusValue": "Aprovado"
                        }
                    ]
                }
            },
            "id": "notion-knowledge",
            "name": "Fetch Medical Brain",
            "type": "n8n-nodes-base.notion",
            "typeVersion": 2,
            "position": [
                250,
                0
            ],
            "credentials": {
                "notionApi": {
                    "id": "YOUR_NOTION_CREDENTIAL_ID",
                    "name": "Notion account"
                }
            }
        },
        {
            "parameters": {
                "mode": "json",
                "json": "={{ $json.results.map(i => `-----------------------------------\\nASSUNTO: ${i.properties.T√≥pico.title[0]?.plain_text}\\nRESPOSTA SUGERIDA: ${i.properties['Resposta Sophia'].rich_text[0]?.plain_text}\\nPOR QUE (Filosofia): ${i.properties['1. Princ√≠pio (Why)'].rich_text[0]?.plain_text}\\nORIENTA√á√ïES PR√ÅTICAS: ${i.properties.Orienta√ß√µes.rich_text[0]?.plain_text}\\nTOM DE VOZ: ${i.properties['3. Nuance/Tom (How)'].rich_text[0]?.plain_text}`).join('\\n\\n') }}"
            },
            "id": "format-context",
            "name": "Format Context",
            "type": "n8n-nodes-base.set",
            "typeVersion": 2,
            "position": [
                450,
                0
            ]
        },
        {
            "parameters": {
                "modelId": {
                    "__rl": true,
                    "value": "gpt-4o",
                    "mode": "list",
                    "cachedResultName": "gpt-4-o"
                },
                "messages": {
                    "values": [
                        {
                            "role": "system",
                            "content": "=Voc√™ √© a SOPHIA, enfermeira virtual da cl√≠nica Calyx do Dr. Paulo. Sua fun√ß√£o √© acolher pacientes de emagrecimento.\n\n### DIRETRIZES DE PERSONALIDADE\n- Use emojis leves (üå∏, üíß, ‚ú®).\n- Seja t√©cnica, mas carinhosa. Use \"querida\", \"fica tranquila\".\n- NUNCA INVENTE TRATAMENTOS. Use APENAS o conhecimento abaixo.\n- Se n√£o souber a resposta no contexto, diga: \"Vou confirmar isso com o Dr. Paulo e j√° te chamo, t√°?\"\n\n### CONHECIMENTO M√âDICO (Transcrito do Dr. Paulo)\n{{ $('Format Context').item.json.json }}\n\n### MENSAGEM DO PACIENTE\n{{ $('Webhook Trigger').item.json.body.text.message }}"
                        },
                        {
                            "content": "={{ $('Webhook Trigger').item.json.body.text.message }}"
                        }
                    ]
                }
            },
            "id": "ai-response",
            "name": "SOPHIA (GPT-4o)",
            "type": "n8n-nodes-base.openAi",
            "typeVersion": 1,
            "position": [
                650,
                0
            ],
            "credentials": {
                "openAiApi": {
                    "id": "YOUR_OPENAI_CREDENTIAL_ID",
                    "name": "OpenAI account"
                }
            }
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://api.z-api.io/instances/3EDC776503AFA1024383BAA76574573D/token/85E2CDA13359AF67A3346060/send-text",
                "sendBody": true,
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "phone",
                            "value": "={{ $('Webhook Trigger').item.json.body.phone }}"
                        },
                        {
                            "name": "message",
                            "value": "={{ $json.message.content }}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "zapi-send",
            "name": "Send WhatsApp (Z-API)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                900,
                0
            ]
        }
    ],
    "connections": {
        "Webhook Trigger": {
            "main": [
                [
                    {
                        "node": "Fetch Medical Brain",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Medical Brain": {
            "main": [
                [
                    {
                        "node": "Format Context",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Format Context": {
            "main": [
                [
                    {
                        "node": "SOPHIA (GPT-4o)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "SOPHIA (GPT-4o)": {
            "main": [
                [
                    {
                        "node": "Return Answer",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}